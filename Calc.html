<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Monte Alto ‚Äì Calculadora de Embutidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: system-ui, sans-serif;
      background: #111827;
      color: #f9fafb;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      max-width: 680px;
      margin: 0 auto;
      background: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
      color: #d1d5db;
      font-size: 0.9rem;
    }

    select, input, button, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.55rem 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #0f172a;
      color: #f9fafb;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        background-color 0.15s ease-out;
    }

    button:active {
      transform: scale(0.97) translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #374151;
      color: white;
    }

    #btn-agregar-carrito {
      background: #fbbf24;
      color: #111827;
      font-weight: 700;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .summary-box {
      background: #030712;
      border: 1px dashed #4b5563;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
    }

    .row > div {
      flex: 1;
    }

    .product-image-wrapper {
      text-align: center;
      margin-top: 0.5rem;
      display: none;
    }

    .product-image-wrapper img {
      max-width: 50%;
      display: block;
      margin: 0 auto;
      border-radius: 0.75rem;
      border: 1px solid #374151;
    }

    .muted { color:#6b7280; font-size:0.85rem; }

    .error-text { color:#fecaca; font-size:0.9rem; min-height:1em; }

    #status {
      white-space:pre-line;
      margin-top:0.75rem;
      font-size:0.9rem;
    }

    #status.status-box-success {
      background:#022c22;
      border:1px solid #10b981;
      padding:0.75rem;
      border-radius:0.5rem;
      color:#d1fae5;
    }

    /* ICONO CARRITO */
    #cart-icon {
      position:absolute;
      top:0.75rem;
      right:0.75rem;
      display:flex;
      align-items:center;
      gap:0.4rem;
      background:#0f172a;
      padding:0.35rem 0.7rem;
      border-radius:999px;
      border:1px solid #374151;
      font-size:0.9rem;
      cursor:pointer;
      user-select:none;
    }
    #cart-icon span.cart-emoji {
      font-size:1.1rem;
    }
    #cart-count {
      background:#fbbf24;
      color:#111827;
      padding:0.1rem 0.45rem;
      border-radius:999px;
      font-weight:700;
      font-size:0.8rem;
      min-width:1.4rem;
      text-align:center;
    }

    .promo-box {
      margin-top:0.5rem;
      font-size:0.85rem;
    }
    .promo-box label {
      display:flex;
      align-items:center;
      gap:0.4rem;
      margin-bottom:0.4rem;
    }
    .promo-box input[type="checkbox"] {
      width:auto;
      margin-bottom:0;
    }

    /* BACKDROP + DRAWER */
    .cart-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      z-index:900;
    }

    .cart-drawer {
      position:fixed;
      top:0;
      right:0;
      width:320px;
      height:100vh;
      background:#020617;
      box-shadow:-4px 0 20px rgba(0,0,0,0.6);
      z-index:1000;
      display:flex;
      flex-direction:column;
      padding:1rem;
      transform: translateX(100%);
      transition: transform 0.25s ease;
    }
    .cart-drawer.open {
      transform: translateX(0);
    }

    .cart-drawer-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.75rem;
    }
    .cart-drawer-header h3 {
      margin:0;
      font-size:1rem;
    }

    .icon-button {
      background:transparent;
      border:none;
      color:#9ca3af;
      font-size:1.2rem;
      padding:0.1rem 0.3rem;
      cursor:pointer;
      box-shadow:none;
    }
    .icon-button:active {
      transform:scale(0.9);
      box-shadow:none;
    }

    .cart-drawer-body {
      flex:1;
      overflow-y:auto;
      font-size:0.9rem;
      border-top:1px solid #111827;
      border-bottom:1px solid #111827;
      padding:0.5rem 0;
    }

    .cart-item-row {
      margin-bottom:0.5rem;
    }

    .cart-drawer-footer {
      margin-top:0.75rem;
    }

    .w-full {
      width:100%;
    }

    #discount-code {
      text-transform:uppercase;
    }
  </style>
</head>

<body>
  <h1>Monte Alto ‚Äì Calculadora</h1>

  <div class="card">

    <div id="cart-icon">
      <span class="cart-emoji">üõí</span>
      <span id="cart-count">0</span>
    </div>

    <!-- PASO 1 -->
    <div id="step-datos" class="step active">
      <h3>Paso 1 ¬∑ Tus datos</h3>

      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Tu nombre" />
        </div>

        <div>
          <label>Tel√©fono</label>
          <input id="telefono" type="tel" placeholder="Ej: 12345678" />
        </div>
      </div>

      <div id="datos-error" class="error-text"></div>
      <div id="puntos-info" class="muted"></div>

      <button id="btn-ir-productos" class="primary">Continuar</button>
    </div>

    <!-- PASO 2 -->
    <div id="step-producto" class="step">
      <h3>Paso 2 ¬∑ Escog√© tu chorizo</h3>

      <label>Tipo de chorizo</label>
      <select id="producto">
        <option value="">‚Äî Selecciona un producto ‚Äî</option>
      </select>

      <div class="product-image-wrapper" id="product-image-wrapper">
        <img id="product-image" src="" />
        <div class="muted" id="product-image-caption"></div>
      </div>

      <label>Peso por paquete</label>
      <select id="peso">
        <option value="">Selecciona el peso...</option>
      </select>

      <label>N√∫mero de paquetes</label>
      <input id="cantidad" type="number" min="1" value="1"/>

      <div class="summary-box">
        Subtotal: <strong id="subtotal-linea">‚Ç°0</strong>
      </div>

      <!-- Notas aqu√≠ -->
      <label id="label-notas">Notas (opcional)</label>
      <textarea id="comentarios" rows="3" placeholder="Ej: Entregar en la tarde"></textarea>

      <button id="btn-agregar-carrito">Agregar al carrito</button>
      <button id="btn-comprar-ya" class="primary">Comprar de una vez</button>
    </div>

    <!-- PASO 3 -->
    <div id="step-cliente" class="step">
      <h3>Paso 3 ¬∑ Confirmaci√≥n del pedido</h3>

      <label id="label-descuento">C√≥digo de descuento (opcional)</label>
      <input id="discount-code" type="text" placeholder="Ej: MONTEALTO10" />

      <div id="sinpe-box" class="summary-box">
        <strong>Pago por SINPE m√≥vil (BAC):</strong><br>
        Envi√° el monto total al n√∫mero <strong>XXXX-XXXX</strong> (Monte Alto).<br>
        En el detalle indic√° tu nombre y ‚ÄúMonte Alto‚Äù.<br>
        Luego presion√° <strong>Confirmar pedido</strong> para registrar tu orden.
      </div>

      <div class="promo-box">
        <label>
          <input type="checkbox" id="chk-promos" />
          <span>Quiero recibir promociones por WhatsApp a este mismo n√∫mero.</span>
        </label>
      </div>

      <div id="resumen-final" class="summary-box"></div>

      <button id="btn-volver-productos" class="secondary">Volver</button>
      <button id="btn-confirmar" class="primary">Confirmar pedido</button>

      <div id="status" class="muted"></div>
      <button id="btn-nuevo-pedido" class="secondary" style="margin-top:0.75rem; display:none;">
        Hacer otro pedido
      </button>
    </div>

  </div>

  <div id="cart-backdrop" class="cart-backdrop"></div>

  <div id="cart-drawer" class="cart-drawer">
    <div class="cart-drawer-header">
      <h3>Tu carrito</h3>
      <button id="btn-cart-close" class="icon-button">&times;</button>
    </div>
    <div id="cart-drawer-body" class="cart-drawer-body">
      <p class="muted">Tu carrito est√° vac√≠o.</p>
    </div>
    <div class="cart-drawer-footer">
      <div class="muted">Total: <strong id="cart-drawer-total">‚Ç°0</strong></div>
      <button id="btn-go-confirm" class="primary w-full" style="margin-top:0.5rem;">
        Ir a confirmar pedido
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ===================== CONFIG B√ÅSICA ===================== */
const CONFIG = {
  SHEETS_ENDPOINT:
    "https://script.google.com/macros/s/AKfycby9Y5YlZPbttjxy85uL1zguMmd4G3sOEIlirbTozvGcYLl837cfgZKhZ1u4MQeSEja4/exec",

  products: [
    { id: "brat",    type: "chorizo", name: "Chorizo Bratwurst",    imageUrl: "Bratwurst.png" },
    { id: "tex",     type: "chorizo", name: "Chorizo Tex-Mex",      imageUrl: "Tex-Mex.png" },
    { id: "criollo", type: "chorizo", name: "Criollo argentino",    imageUrl: "Argentino.png" },
    { id: "carib",   type: "chorizo", name: "Chorizo Caribe√±o",     imageUrl: "Caribe√±o.png" },
    { id: "tico",    type: "chorizo", name: "Costarricense casero", imageUrl: "Criollo.png" },
    { id: "bacon",   type: "bacon",   name: "Bacon ahumado",        imageUrl: "Tocineta.png" }
  ],

  weights: [
    { id: "500",  grams: 500,  label: "¬Ω kilo (500g)" },
    { id: "1000", grams: 1000, label: "1 kilo (1000g)" }
  ]
};

/* <<< AQU√ç EDIT√ÅS LOS PRECIOS POR GRAMO >>> */
const PRICE_PER_GRAM_CHORIZO = 7.8;  // colones por gramo
const PRICE_PER_GRAM_BACON   = 12.0; // colones por gramo

/* ===================== ESTADO ===================== */
let sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
let cart = [];

const state = {
  nombre:"",
  telefono:"",
  comentarios:"",
  discountCode:"",
  currentProductId:"",
  currentWeightId:"",
  currentQuantity:1,
  wantsPromos:false
};

/* ===================== UTILIDADES ===================== */
function formatCRC(v){ return "‚Ç°"+(v||0).toLocaleString("es-CR"); }

function getSelectedProduct(){
  return CONFIG.products.find(p=>p.id===state.currentProductId) || null;
}

function getSelectedWeight(){
  return CONFIG.weights.find(w=>w.id===state.currentWeightId) || null;
}

function calculateLineTotal(product, grams, quantity){
  if(!product || !grams || !quantity) return 0;

  const totalGrams = grams * quantity;
  const perGram =
    product.type === "bacon"
      ? PRICE_PER_GRAM_BACON
      : PRICE_PER_GRAM_CHORIZO;

  return Math.round(totalGrams * perGram);
}

function calculateSubtotal(){
  const p=getSelectedProduct();
  const w=getSelectedWeight();
  if(!p || !w) return 0;
  return calculateLineTotal(p, w.grams, state.currentQuantity);
}

function getNextSaturday(fromDate = new Date()){
  const d = new Date(fromDate);
  const day = d.getDay();
  const diff = (6 - day + 7) % 7;
  d.setDate(d.getDate() + diff);
  return d;
}

/* ===================== CONFETTI ===================== */
function burstConfettiSmallFromElement(el) {
  if (typeof confetti !== "function" || !el) return;
  const rect = el.getBoundingClientRect();
  const x = (rect.left + rect.width / 2) / window.innerWidth;
  const y = (rect.top + rect.height / 2) / window.innerHeight;
  confetti({
    particleCount: 25,
    spread: 45,
    startVelocity: 35,
    scalar: 0.7,
    origin: { x, y }
  });
}

function burstConfettiBigCenter() {
  if (typeof confetti !== "function") return;
  confetti({
    particleCount: 90,
    spread: 70,
    startVelocity: 40,
    scalar: 1.1,
    origin: { x: 0.5, y: 0.5 }
  });
}

/* ===================== PUNTOS TEL√âFONO ===================== */
async function fetchPointsForPhone(phone){
  const infoEl = document.getElementById("puntos-info");
  const clean = (phone || "").trim();

  if (clean.length < 8) {
    infoEl.textContent = "";
    return;
  }

  try {
    const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({
        action:"getPoints",
        telefono: clean
      })
    });

    if(!res.ok){
      console.warn("Error HTTP getPoints:", res.status, res.statusText);
      infoEl.textContent = "";
      return;
    }

    const data = await res.json();

    if (data.success) {
      const pts = Number(data.points || 0);
      if (pts > 0) {
        infoEl.textContent = `Ten√©s ${pts} puntos acumulados.`;
      } else {
        infoEl.textContent = "No registramos puntos acumulados a√∫n.";
      }
    } else {
      infoEl.textContent = "";
    }
  } catch (err){
    console.error("Error en fetchPointsForPhone:", err);
    infoEl.textContent = "";
  }
}

/* ===================== CARRITO ===================== */
function openCartDrawer(){
  if(cart.length===0){
    alert("Tu carrito est√° vac√≠o.");
    return;
  }
  document.getElementById("cart-drawer").classList.add("open");
  document.getElementById("cart-backdrop").style.display = "block";
}

function closeCartDrawer(){
  document.getElementById("cart-drawer").classList.remove("open");
  document.getElementById("cart-backdrop").style.display = "none";
}

function updateCartUI(){
  const countEl = document.getElementById("cart-count");
  const bodyEl  = document.getElementById("cart-drawer-body");
  const totalEl = document.getElementById("cart-drawer-total");

  countEl.textContent = cart.length.toString();
  bodyEl.innerHTML = "";

  if(cart.length===0){
    bodyEl.innerHTML = '<p class="muted">Tu carrito est√° vac√≠o.</p>';
    totalEl.textContent = "‚Ç°0";
    return;
  }

  cart.forEach(item=>{
    const div = document.createElement("div");
    div.className = "cart-item-row";
    div.innerHTML =
      `<div><strong>${item.quantity} x ${item.productName}</strong></div>
       <div class="muted">${item.packLabel}</div>
       <div>${formatCRC(item.lineTotal)}</div>`;
    bodyEl.appendChild(div);
  });

  const total = cart.reduce((s,c)=>s+c.lineTotal,0);
  totalEl.textContent = formatCRC(total);
}

/* ===================== SEND ORDER ===================== */
async function sendOrder() {
  const statusEl = document.getElementById("status");
  const btnNuevo = document.getElementById("btn-nuevo-pedido");
  statusEl.classList.remove("status-box-success");
  btnNuevo.style.display = "none";

  const nombreSeguro = ((state && state.nombre) || "").trim() || "cliente";

  try {
    if (!Array.isArray(cart) || cart.length === 0) {
      statusEl.textContent = "Agreg√° al menos un producto al carrito antes de confirmar.";
      return;
    }

    statusEl.textContent = `Enviando tu pedido, ${nombreSeguro}...`;

    const totalColones = cart.reduce((suma, item) => suma + Number(item.lineTotal || 0), 0);

    const cartLines = cart
      .map(item => {
        const qty = item.quantity ?? 0;
        const name = item.productName ?? "Producto";
        const pack = item.packLabel ?? "";
        const lineTotal = Number(item.lineTotal || 0);
        return `${qty} x ${name} (${pack}) ‚Äì ${formatCRC(lineTotal)}`;
      })
      .join("\n");

    const presentacionResumen = cart
      .map(item => `${item.quantity ?? 0} x ${item.packLabel ?? ""}`)
      .join(", ");

    const pesoTotalGramos = cart.reduce(
      (suma, item) => suma + (Number(item.grams || 0) * Number(item.quantity || 0)),
      0
    );

    const primerProducto = cart[0]?.productName || "Calculadora Monte Alto";

    let comentariosBase = (state && state.comentarios) || "";
    if (state.discountCode) {
      comentariosBase += `\nC√≥digo de descuento: ${state.discountCode}`;
    }
    comentariosBase += `\nM√©todo de pago: SINPE m√≥vil BAC`;
    const comentariosFinal = comentariosBase + "\n" + cartLines;

    const payload = {
      action: "saveOrder",
      sessionId: sessionId,
      nombre: state.nombre || "",
      telefono: state.telefono || "",
      comentarios: comentariosFinal,
      cantidad: cart.length,
      totalColones: totalColones,
      puntos: 0,
      productoId: primerProducto,
      presentacionResumen: presentacionResumen,
      pesoTotalGramos: pesoTotalGramos,
      discountCode: state.discountCode || "",
      promoAccepted: state.wantsPromos ? "Si" : ""
    };

    const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      statusEl.textContent =
        `Error enviando el pedido (HTTP ${res.status}: ${res.statusText}). Verific√° la URL del Apps Script.`;
      return;
    }

    try { await res.text(); } catch(e){}

    burstConfettiBigCenter();

    const resumenHtml = cart
      .map(item =>
        `${item.quantity} x ${item.productName} (${item.packLabel}) ‚Äì ${formatCRC(item.lineTotal)}`
      )
      .join("<br>");

    const entregaDate = getNextSaturday(new Date());
    const entregaStr = entregaDate.toLocaleDateString("es-CR", {
      weekday: "long",
      day: "numeric",
      month: "long"
    });

    statusEl.innerHTML =
      `¬°Gracias por tu compra, ${nombreSeguro}! üß°<br><br>` +
      `<strong>Resumen de tu pedido:</strong><br>` +
      `${resumenHtml}<br><br>` +
      `<strong>Total:</strong> ${formatCRC(totalColones)}<br>` +
      `<strong>Fecha estimada de entrega:</strong> ${entregaStr}`;

    statusEl.classList.add("status-box-success");
    btnNuevo.style.display = "inline-block";

    document.getElementById("label-descuento").style.display = "none";
    document.getElementById("discount-code").style.display = "none";
    document.getElementById("sinpe-box").style.display = "none";
    document.getElementById("chk-promos").disabled = true;
    document.getElementById("btn-volver-productos").style.display = "none";
    document.getElementById("btn-confirmar").style.display = "none";

    cart = [];
    updateCartUI();
    document.getElementById("resumen-final").innerHTML = "";

  } catch (err) {
    console.error("Error en sendOrder():", err);
    statusEl.textContent =
      "Hubo un problema enviando tu pedido.\nDetalle t√©cnico: " + (err && err.message ? err.message : String(err));
  }
}

/* ===================== RESET ===================== */
function resetForNewOrder(){
  sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;

  state.nombre = "";
  state.telefono = "";
  state.comentarios = "";
  state.discountCode = "";
  state.currentProductId = "";
  state.currentWeightId = "";
  state.currentQuantity = 1;
  state.wantsPromos = false;

  cart = [];
  updateCartUI();

  document.getElementById("nombre").value = "";
  document.getElementById("telefono").value = "";
  document.getElementById("comentarios").value = "";
  document.getElementById("discount-code").value = "";
  document.getElementById("datos-error").textContent = "";
  document.getElementById("puntos-info").textContent = "";
  document.getElementById("subtotal-linea").textContent = "‚Ç°0";
  document.getElementById("producto").value = "";
  document.getElementById("peso").value = "";
  document.getElementById("cantidad").value = 1;
  document.getElementById("product-image-wrapper").style.display = "none";

  const statusEl = document.getElementById("status");
  statusEl.textContent = "";
  statusEl.classList.remove("status-box-success");
  document.getElementById("btn-nuevo-pedido").style.display = "none";

  document.getElementById("chk-promos").checked = false;
  document.getElementById("chk-promos").disabled = false;

  document.getElementById("step-datos").classList.add("active");
  document.getElementById("step-producto").classList.remove("active");
  document.getElementById("step-cliente").classList.remove("active");

  document.getElementById("label-descuento").style.display = "";
  document.getElementById("discount-code").style.display = "";
  document.getElementById("sinpe-box").style.display = "";
  document.getElementById("btn-volver-productos").style.display = "";
  document.getElementById("btn-confirmar").style.display = "";
}

/* ===================== SETUP ===================== */
function setup(){
  const productoSelect = document.getElementById("producto");
  const pesoSelect = document.getElementById("peso");
  const telInput = document.getElementById("telefono");
  const discountInput = document.getElementById("discount-code");
  const chkPromos = document.getElementById("chk-promos");
  const btnNuevo = document.getElementById("btn-nuevo-pedido");

  CONFIG.products.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent=p.name;
    productoSelect.appendChild(o);
  });

  CONFIG.weights.forEach(w=>{
    const o=document.createElement("option");
    o.value=w.id;
    o.textContent=w.label;
    pesoSelect.appendChild(o);
  });

  let lastPointsPhone = "";
  telInput.addEventListener("input", ()=> {
    const raw   = telInput.value || "";
    const clean = raw.replace(/\D/g,"").trim();
    if (clean.length >= 8 && clean !== lastPointsPhone) {
      lastPointsPhone = clean;
      fetchPointsForPhone(clean);
    } else if (clean.length < 8) {
      document.getElementById("puntos-info").textContent = "";
      lastPointsPhone = "";
    }
  });

  discountInput.addEventListener("input", ()=>{
    discountInput.value = discountInput.value.toUpperCase();
  });

  chkPromos.addEventListener("change", ()=>{
    state.wantsPromos = chkPromos.checked;
  });

  document.getElementById("btn-ir-productos").onclick = ()=>{
    const n=document.getElementById("nombre").value.trim();
    const t=telInput.value.trim();
    const err=document.getElementById("datos-error");
    if(!n){ err.textContent="Ingres√° tu nombre."; return; }
    if(!t || t.replace(/\D/g,"").length<8){ err.textContent="Tel√©fono inv√°lido."; return; }
    state.nombre=n;
    state.telefono=t;
    document.getElementById("step-datos").classList.remove("active");
    document.getElementById("step-producto").classList.add("active");
  };

  productoSelect.onchange = ()=>{
    state.currentProductId = productoSelect.value;
    const p = getSelectedProduct();
    const imgWrap=document.getElementById("product-image-wrapper");
    const img=document.getElementById("product-image");
    const caption=document.getElementById("product-image-caption");
    if(p){
      img.src=p.imageUrl;
      caption.textContent=p.name;
      imgWrap.style.display="block";
    } else {
      imgWrap.style.display="none";
      img.src="";
    }
    document.getElementById("subtotal-linea").textContent =
      formatCRC(calculateSubtotal());
  };

  pesoSelect.onchange = ()=>{
    state.currentWeightId = pesoSelect.value;
    document.getElementById("subtotal-linea").textContent =
      formatCRC(calculateSubtotal());
  };

  document.getElementById("cantidad").oninput = ()=>{
    state.currentQuantity = Number(document.getElementById("cantidad").value)||1;
    document.getElementById("subtotal-linea").textContent =
      formatCRC(calculateSubtotal());
  };

  const btnAgregar = document.getElementById("btn-agregar-carrito");
  btnAgregar.onclick = ()=>{
    const p=getSelectedProduct();
    const w=getSelectedWeight();
    if(!p || !w){
      alert("Revis√° que escogiste el chorizo/tocineta y el peso.");
      return;
    }
    state.comentarios = document.getElementById("comentarios").value.trim();
    const qty = state.currentQuantity;
    const lineTotal = calculateLineTotal(p, w.grams, qty);
    cart.push({
      productId: p.id,
      productName: p.name,
      packLabel: w.label,
      grams: w.grams,
      quantity: qty,
      lineTotal
    });
    updateCartUI();
    burstConfettiSmallFromElement(btnAgregar);
    state.currentProductId="";
    state.currentWeightId="";
    state.currentQuantity=1;
    document.getElementById("producto").value="";
    document.getElementById("peso").value="";
    document.getElementById("cantidad").value=1;
    document.getElementById("product-image-wrapper").style.display="none";
    document.getElementById("subtotal-linea").textContent="‚Ç°0";
  };

  document.getElementById("btn-comprar-ya").onclick = ()=>{
    if(cart.length===0){
      alert("Agreg√° algo al carrito.");
      return;
    }
    state.comentarios = document.getElementById("comentarios").value.trim();
    document.getElementById("step-producto").classList.remove("active");
    document.getElementById("step-cliente").classList.add("active");
    updateResumenFinal();
  };

  document.getElementById("btn-volver-productos").onclick = ()=>{
    document.getElementById("step-cliente").classList.remove("active");
    document.getElementById("step-producto").classList.add("active");
  };

  document.getElementById("btn-confirmar").onclick = ()=>{
    state.discountCode = document.getElementById("discount-code").value.trim().toUpperCase();
    sendOrder();
  };

  btnNuevo.onclick = resetForNewOrder;

  document.getElementById("cart-icon").onclick = openCartDrawer;
  document.getElementById("cart-backdrop").onclick = closeCartDrawer;
  document.getElementById("btn-cart-close").onclick = closeCartDrawer;

  document.getElementById("btn-go-confirm").onclick = ()=>{
    if(cart.length===0){
      alert("Tu carrito est√° vac√≠o.");
      return;
    }
    closeCartDrawer();
    document.getElementById("step-producto").classList.remove("active");
    document.getElementById("step-cliente").classList.add("active");
    updateResumenFinal();
  };

  updateCartUI();
}

function updateResumenFinal(){
  const total = cart.reduce((s,c)=>s+c.lineTotal,0);
  const list = cart.map(i =>
    `${i.quantity} x ${i.productName} (${i.packLabel}) ‚Äì ${formatCRC(i.lineTotal)}`
  ).join("<br>");
  document.getElementById("resumen-final").innerHTML =
    `<strong>Resumen de tu compra:</strong><br>${list}<br><br>
     <strong>Total:</strong> ${formatCRC(total)}`;
}

window.onload = ()=> setup();
</script>

</body>
</html>
