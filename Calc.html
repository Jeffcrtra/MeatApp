<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>12 am Monte Alto ‚Äì Calculadora de Embutidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: system-ui, sans-serif;
      background: #111827;
      color: #f9fafb;
      margin: 0;
      padding: 1rem;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      max-width: 680px;
      margin: 0 auto;
      background: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
      color: #d1d5db;
      font-size: 0.9rem;
    }

    select, input, button, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.55rem 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #0f172a;
      color: #f9fafb;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
      transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.08s ease-out,
        background-color 0.15s ease-out;
    }

    button:active {
      transform: scale(0.97) translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #374151;
      color: white;
    }

    #btn-agregar-carrito {
      background: #fbbf24;
      color: #111827;
      font-weight: 700;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .summary-box {
      background: #030712;
      border: 1px dashed #4b5563;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
    }

    .row > div {
      flex: 1;
    }

    .product-image-wrapper {
      text-align: center;
      margin-top: 0.5rem;
      display: none;
    }

    .product-image-wrapper img {
      max-width: 50%;
      display: block;
      margin: 0 auto;
      border-radius: 0.75rem;
      border: 1px solid #374151;
    }

    .muted {
      color:#6b7280;
      font-size:0.85rem;
    }

    .error-text {
      color:#fecaca;
      font-size:0.9rem;
      min-height:1em;
    }

    #status {
      white-space:pre-line;
      margin-top:0.75rem;
      font-size:0.9rem;
    }

    #status.status-box-success {
      background:#022c22;
      border:1px solid #10b981;
      padding:0.75rem;
      border-radius:0.5rem;
      color:#d1fae5;
    }

    /* ICONO CARRITO */
    #cart-icon {
      position:absolute;
      top:0.75rem;
      right:0.75rem;
      display:flex;
      align-items:center;
      gap:0.4rem;
      background:#0f172a;
      padding:0.35rem 0.7rem;
      border-radius:999px;
      border:1px solid #374151;
      font-size:0.9rem;
      cursor:pointer;
      user-select:none;
      z-index:20;
    }
    #cart-icon span.cart-emoji {
      font-size:1.1rem;
    }
    #cart-count {
      background:#fbbf24;
      color:#111827;
      padding:0.1rem 0.45rem;
      border-radius:999px;
      font-weight:700;
      font-size:0.8rem;
      min-width:1.4rem;
      text-align:center;
    }

    .promo-box {
      margin-top:0.5rem;
      font-size:0.85rem;
    }
    .promo-box label {
      display:flex;
      align-items:center;
      gap:0.4rem;
      margin-bottom:0.4rem;
    }
    .promo-box input[type="checkbox"] {
      width:auto;
      margin-bottom:0;
    }

    /* BACKDROP + DRAWER */
    .cart-backdrop {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      z-index:900;
    }

    .cart-drawer {
      position:fixed;
      top:0;
      right:0;
      width:320px;
      height:100vh;
      background:#020617;
      box-shadow:-4px 0 20px rgba(0,0,0,0.6);
      z-index:1000;
      display:flex;
      flex-direction:column;
      padding:1rem;
      transform: translateX(100%);
      transition: transform 0.25s ease;
    }
    .cart-drawer.open {
      transform: translateX(0);
    }

    .cart-drawer-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.75rem;
    }
    .cart-drawer-header h3 {
      margin:0;
      font-size:1rem;
    }

    .icon-button {
      background:transparent;
      border:none;
      color:#9ca3af;
      font-size:1.2rem;
      padding:0.1rem 0.3rem;
      cursor:pointer;
      box-shadow:none;
    }
    .icon-button:active {
      transform:scale(0.9);
      box-shadow:none;
    }

    .cart-drawer-body {
      flex:1;
      overflow-y:auto;
      font-size:0.9rem;
      border-top:1px solid #111827;
      border-bottom:1px solid #111827;
      padding:0.5rem 0;
    }

    .cart-item-row {
      margin-bottom:0.5rem;
      padding-bottom:0.4rem;
      border-bottom:1px dashed #1f2937;
      display:flex;
      gap:0.5rem;
      align-items:flex-start;
    }
    .cart-item-icon {
      font-size:1.1rem;
      margin-top:0.1rem;
    }
    .cart-item-main {
      flex:1;
    }
    .cart-item-name {
      font-weight:600;
    }
    .cart-item-pack {
      font-size:0.8rem;
      color:#9ca3af;
    }
    .cart-item-price {
      font-weight:600;
      white-space:nowrap;
    }

    .cart-drawer-footer {
      margin-top:0.75rem;
      padding-bottom: 2.5rem;
    }

    .w-full {
      width:100%;
    }

    #discount-code {
      text-transform:uppercase;
    }

    /* PUNTOS LEALTAD */
    #puntos-info {
      min-height: 1.2em;
      margin-top: 0.25rem;
      font-size: 0.9rem;
    }
    #puntos-info.has-points {
      color: #fbbf24;
      font-weight: 600;
    }
    #puntos-info.no-points {
      color: #9ca3af;
    }

    #recom-info {
      min-height: 1em;
      margin-top: 0.25rem;
      font-size: 0.85rem;
      color:#9ca3af;
    }

    /* TOGGLE TEMA */
    .theme-toggle {
      position:absolute;
      top:0.75rem;
      left:0.75rem;
      display:flex;
      gap:0.4rem;
      z-index:20;
    }
    .theme-pill {
      display:flex;
      align-items:center;
      gap:0.25rem;
      padding:0.15rem 0.55rem;
      border-radius:999px;
      border:1px solid #374151;
      background:#020617;
      font-size:0.75rem;
      color:#9ca3af;
      cursor:pointer;
      box-shadow:none;
    }
    .theme-pill span.icon {
      font-size:0.85rem;
    }
    .theme-pill.active {
      background:#fbbf24;
      color:#111827;
      border-color:#fbbf24;
      font-weight:600;
    }

    /* CREDITS */
    .credits {
      max-width:680px;
      margin:0.5rem auto 0;
      text-align:center;
      font-size:0.75rem;
      color:#6b7280;
    }
    .credits a {
      color:#9ca3af;
      text-decoration:none;
    }
    .credits a:hover {
      text-decoration:underline;
    }

    /* LIGHT THEME OVERRIDES */
    body.theme-light {
      background:#e5e7eb;
      color:#111827;
    }
    body.theme-light .card {
      background:#ffffff;
      box-shadow:0 6px 18px rgba(15,23,42,0.25);
    }
    body.theme-light select,
    body.theme-light input,
    body.theme-light textarea {
      background:#f9fafb;
      color:#111827;
      border-color:#d1d5db;
    }
    body.theme-light .summary-box {
      background:#f9fafb;
      border-color:#d1d5db;
    }
    body.theme-light .muted {
      color:#6b7280;
    }
    body.theme-light #status.status-box-success {
      background:#ecfdf5;
      border-color:#16a34a;
      color:#14532d;
    }
    body.theme-light #cart-icon {
      background:#f9fafb;
      border-color:#d1d5db;
    }
    body.theme-light .cart-drawer {
      background:#ffffff;
    }
    body.theme-light .cart-drawer-body {
      border-top-color:#e5e7eb;
      border-bottom-color:#e5e7eb;
    }

    /* CART ICON FLOATING ON MOBILE */
    @media (max-width: 640px) {
      #cart-icon {
        position:fixed;
        top:auto;
        right:1rem;
        bottom:1rem;
      }
    }
  </style>
</head>

<body>
  <h1>Monte Alto ‚Äì Calculadora</h1>

  <!-- Sonidos -->
<audio id="sound-add" src="click-add-pop.wav" preload="auto"></audio>
<audio id="sound-send" src="click-send-confirm.wav" preload="auto"></audio>

  <div class="card">

    <!-- Toggle tema -->
    <div class="theme-toggle">
      <button class="theme-pill" data-theme="light">
        <span class="icon">‚òÄÔ∏è</span><span>Claro</span>
      </button>
      <button class="theme-pill active" data-theme="dark">
        <span class="icon">üåô</span><span>Oscuro</span>
      </button>
    </div>

    <!-- Carrito -->
    <div id="cart-icon">
      <span class="cart-emoji">üõí</span>
      <span id="cart-count">0</span>
    </div>

    <!-- PASO 1 -->
    <div id="step-datos" class="step active">
      <h3>Paso 1 ¬∑ Tus datos</h3>

      <div class="row">
        <div>
          <label>Tel√©fono</label>
          <input id="telefono" type="tel" placeholder="Ej: 6066-8322" />
        </div>

        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Tu nombre" />
        </div>
      </div>

      <div id="puntos-info"></div>
      <div id="recom-info"></div>
      <div id="datos-error" class="error-text"></div>

      <button id="btn-ir-productos" class="primary" disabled>Continuar</button>
    </div>

    <!-- PASO 2 -->
    <div id="step-producto" class="step">
      <h3>Paso 2 ¬∑ Escog√© tu chorizo</h3>

      <label>Tipo de chorizo</label>
      <select id="producto">
        <option value="">‚Äî Selecciona un producto ‚Äî</option>
      </select>

      <div class="product-image-wrapper" id="product-image-wrapper">
        <img id="product-image" src="" />
        <div class="muted" id="product-image-caption"></div>
      </div>

      <label>Peso por paquete</label>
      <select id="peso">
        <option value="">Selecciona el peso...</option>
      </select>

      <label>N√∫mero de paquetes</label>
      <input id="cantidad" type="number" min="1" value="1"/>

      <div class="summary-box">
        Subtotal: <strong id="subtotal-linea">‚Ç°0</strong>
      </div>

      <label id="label-notas">Notas (opcional)</label>
      <textarea id="comentarios" rows="3" placeholder="Ej: Con poco picante"></textarea>

      <button id="btn-agregar-carrito">Agregar al carrito</button>
      <button id="btn-comprar-ya" class="primary">Comprar de una vez</button>
    </div>

    <!-- PASO 3 -->
    <div id="step-cliente" class="step">
      <h3>Paso 3 ¬∑ Confirmaci√≥n del pedido</h3>

      <label id="label-descuento">C√≥digo de descuento (opcional)</label>
      <input id="discount-code" type="text" placeholder="Ej: MONTEALTO10" />

      <div id="sinpe-box" class="summary-box">
        <strong>Pago por SINPE m√≥vil (BAC):</strong><br>
        Envi√° el monto total al n√∫mero <strong>6066-8322</strong> (Marianela Esquivel).<br>
        En el detalle indic√° tu orden.
      </div>

      <div class="promo-box">
        <label>
          <input type="checkbox" id="chk-promos" />
          <span>Quiero recibir promociones por WhatsApp a este mismo n√∫mero.</span>
        </label>
      </div>

      <button id="btn-volver-productos" class="secondary">Volver</button>
      <button id="btn-confirmar" class="primary">Confirmar pedido</button>

      <div id="status" class="muted"></div>
      <button id="btn-nuevo-pedido" class="secondary" style="margin-top:0.75rem; display:none;">
        Hacer otro pedido
      </button>
    </div>

  </div>

  <div id="cart-backdrop" class="cart-backdrop"></div>

  <div id="cart-drawer" class="cart-drawer">
    <div class="cart-drawer-header">
      <h3>Tu carrito</h3>
      <button id="btn-cart-close" class="icon-button">&times;</button>
    </div>
    <div id="cart-drawer-body" class="cart-drawer-body">
      <p class="muted">Tu carrito est√° vac√≠o.</p>
    </div>
    <div class="cart-drawer-footer">
      <div class="muted">Subtotal: <strong id="cart-drawer-subtotal">‚Ç°0</strong></div>
      <div class="muted" id="cart-drawer-discount" style="display:none;">
        Descuento: <strong id="cart-drawer-discount-amount">‚Ç°0</strong>
      </div>
      <div class="muted"><strong>Total:</strong> <strong id="cart-drawer-total">‚Ç°0</strong></div>
      <button id="btn-go-confirm" class="primary w-full" style="margin-top:0.5rem;">
        Ir a confirmar pedido
      </button>
    </div>
  </div>

  <p class="credits">
    Calculadora web realizada por
    <a href="https://www.linkedin.com/in/jeffrey-trigueros-371191123/" target="_blank" rel="noopener noreferrer">
      Jeffrey Trigueros
    </a>.
  </p>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
  /* ===================== CONFIG B√ÅSICA ===================== */
  const CONFIG = {
    SHEETS_ENDPOINT:
      "https://script.google.com/macros/s/AKfycbxrWQZfdFBOSo75tNlCjHXtad67DKMu5BzXOU7mapsZmVzQWC7td4Y7XpD96EdwxYGj/exec",

    products: [
      { id: "brat",    type: "chorizo", name: "Chorizo Bratwurst",    imageUrl: "Bratwurst.png" },
      { id: "tex",     type: "chorizo", name: "Chorizo Tex-Mex",      imageUrl: "Tex-Mex.png" },
      { id: "criollo", type: "chorizo", name: "Criollo argentino",    imageUrl: "Argentino.png" },
      { id: "carib",   type: "chorizo", name: "Chorizo Caribe√±o",     imageUrl: "Caribe√±o.png" },
      { id: "tico",    type: "chorizo", name: "Costarricense casero", imageUrl: "Criollo.png" },
      { id: "bacon",   type: "bacon",   name: "Bacon ahumado",        imageUrl: "Tocineta.png" }
    ],

    weights: [
      { id: "500",  grams: 500,  label: "¬Ω kilo (500g)" },
      { id: "1000", grams: 1000, label: "1 kilo (1000g)" }
    ]
  };

  /* Precios por gramo (fallback) */
  let pricePerGramChorizo = 8.5;
  let pricePerGramBacon   = 11.0;

  /* ===================== ESTADO ===================== */
  let sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  let cart = [];

  const state = {
    nombre: "",
    telefono: "",
    comentarios: "",
    discountCode: "",
    currentProductId: "",
    currentWeightId: "",
    currentQuantity: 1,
    wantsPromos: false,
    pointsChecked: false,
    customerProfile: {
      pointsBefore: 0,
      totalOrders: 0,
      usedFirstDiscount: false,
      lastProduct: "",
      lastPresentacion: ""
    },
    discount: {
      percent: 0,
      label: ""
    }
  };

  /* ===================== UTILIDADES ===================== */
  function formatCRC(v) {
    return "‚Ç°" + (v || 0).toLocaleString("es-CR");
  }

  function getSelectedProduct() {
    return CONFIG.products.find(p => p.id === state.currentProductId) || null;
  }

  function getSelectedWeight() {
    return CONFIG.weights.find(w => w.id === state.currentWeightId) || null;
  }

  function calculateLineTotal(product, grams, quantity) {
    if (!product || !grams || !quantity) return 0;

    const totalGrams = grams * quantity;
    const perGram = product.type === "bacon" ? pricePerGramBacon : pricePerGramChorizo;

    return Math.round(totalGrams * perGram);
  }

  function calculateSubtotal() {
    const p = getSelectedProduct();
    const w = getSelectedWeight();
    if (!p || !w) return 0;
    return calculateLineTotal(p, w.grams, state.currentQuantity);
  }

  function getNextSaturday(fromDate = new Date()) {
    const d = new Date(fromDate);
    const day = d.getDay();
    const diff = (6 - day + 7) % 7;
    d.setDate(d.getDate() + diff);
    return d;
  }

  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
      navigator.userAgent || ""
    );
  }

  /* ===================== AUDIO + VIBRACI√ìN ===================== */
  function playFeedback(type) {
    var audioId = (type === "send") ? "sound-send" : "sound-add";
    var audio = document.getElementById(audioId);
    if (audio) {
      try {
        audio.currentTime = 0;
        audio.play().catch(function(){});
      } catch (e) {}
    }
    if (navigator.vibrate) {
      navigator.vibrate(30);
    }
  }

  /* ===================== CONFETTI ===================== */
  function burstConfettiSmallFromElement(el) {
    if (typeof confetti !== "function" || !el) return;
    const rect = el.getBoundingClientRect();
    const x = (rect.left + rect.width / 2) / window.innerWidth;
    const y = (rect.top + rect.height / 2) / window.innerHeight;
    confetti({
      particleCount: 25,
      spread: 45,
      startVelocity: 35,
      scalar: 0.7,
      origin: { x, y }
    });
  }

  function burstConfettiBigCenter() {
    if (typeof confetti !== "function") return;
    confetti({
      particleCount: 90,
      spread: 70,
      startVelocity: 40,
      scalar: 1.1,
      origin: { x: 0.5, y: 0.5 }
    });
  }

  /* ===================== TEMA CLARO/OSCURO ===================== */
  function applyTheme(theme) {
    const body = document.body;
    const pills = document.querySelectorAll(".theme-pill");
    if (theme === "light") {
      body.classList.add("theme-light");
    } else {
      body.classList.remove("theme-light");
      theme = "dark";
    }
    pills.forEach(p => {
      p.classList.toggle("active", p.dataset.theme === theme);
    });
    try {
      localStorage.setItem("ma_theme", theme);
    } catch (e) {}
  }

  function initTheme() {
    let saved = null;
    try {
      saved = localStorage.getItem("ma_theme");
    } catch (e) {}
    if (!saved) {
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      saved = prefersDark ? "dark" : "light";
    }
    applyTheme(saved);
  }

  /* ===================== PUNTOS + PERFIL CLIENTE ===================== */
  async function fetchPointsForPhone(phone) {
    const infoEl = document.getElementById("puntos-info");
    const recomEl = document.getElementById("recom-info");
    const clean = (phone || "").trim();

    recomEl.textContent = "";

    if (clean.length < 8) {
      infoEl.textContent = "";
      infoEl.classList.remove("has-points", "no-points");
      state.pointsChecked = false;
      state.customerProfile = {
        pointsBefore: 0,
        totalOrders: 0,
        usedFirstDiscount: false,
        lastProduct: "",
        lastPresentacion: ""
      };
      updateContinueButtonState();
      return;
    }

    try {
      const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "getCustomerProfile",
          telefono: clean
        })
      });

      if (!res.ok) {
        console.warn("Error HTTP getCustomerProfile:", res.status, res.statusText);
        infoEl.textContent = "";
        infoEl.classList.remove("has-points", "no-points");
        state.pointsChecked = false;
        updateContinueButtonState();
        return;
      }

      const data = await res.json();

      if (data.success) {
        const pts = Number(data.points || 0);
        const totalOrders = Number(data.totalOrders || 0);
        const usedFirstDiscount = !!data.usedFirstDiscount;
        const lastProduct = data.lastProduct || "";
        const lastPresentacion = data.lastPresentacion || "";

        state.customerProfile = {
          pointsBefore: pts,
          totalOrders,
          usedFirstDiscount,
          lastProduct,
          lastPresentacion
        };

        if (pts > 0) {
          infoEl.innerHTML = "üéâ <strong>Ten√©s " + pts + " puntos</strong> acumulados en Monte Alto üß°";
          infoEl.classList.add("has-points");
          infoEl.classList.remove("no-points");
        } else {
          infoEl.innerHTML = "‚≠ê <strong>Empez√°s desde cero.</strong> Este n√∫mero a√∫n no tiene puntos acumulados.";
          infoEl.classList.add("no-points");
          infoEl.classList.remove("has-points");
        }

        if (totalOrders > 0 && lastProduct) {
          let texto = "La √∫ltima vez compraste " + lastProduct;
          if (lastPresentacion) {
            texto += " (" + lastPresentacion + ")";
          }
          texto += ". ¬øQuer√©s repetir algo similar?";
          recomEl.textContent = texto;
        }

        state.pointsChecked = true;
        updateContinueButtonState();
      } else {
        infoEl.textContent = "";
        infoEl.classList.remove("has-points", "no-points");
        state.pointsChecked = false;
        updateContinueButtonState();
      }
    } catch (err) {
      console.error("Error en fetchPointsForPhone:", err);
      infoEl.textContent = "";
      infoEl.classList.remove("has-points", "no-points");
      state.pointsChecked = false;
      updateContinueButtonState();
    }
  }

  /* ===================== CONFIG: GET Z1‚ÄìAC1 (solo precios) ===================== */
  async function loadConfigFromSheet() {
    try {
      const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "getConfig" })
      });

      if (!res.ok) {
        console.warn("Error HTTP getConfig:", res.status, res.statusText);
        return;
      }

      const data = await res.json();
      console.log("Config recibida de Sheets:", data);

      if (data.success) {
        const aa = Number(data.AA1);
        const ac = Number(data.AC1);

        if (!isNaN(aa) && aa > 0) {
          pricePerGramChorizo = aa;
        }
        if (!isNaN(ac) && ac > 0) {
          pricePerGramBacon = ac;
        }
      } else {
        console.warn("getConfig sin √©xito:", data.message);
      }
    } catch (err) {
      console.error("Error en loadConfigFromSheet:", err);
    }
  }

  /* ===================== DESCUENTOS ===================== */
  function computeDiscount(subtotal) {
    const profile = state.customerProfile;
    let percent = 0;
    let label = "";

    if (profile.totalOrders === 0 && !profile.usedFirstDiscount) {
      // Primera compra
      percent = 15;
      label = "PRIMERA15 (15%)";
      state.discountCode = "PRIMERA15";
    } else if (profile.totalOrders > 0) {
      // Cliente recurrente
      percent = 5;
      if (cart.length > 1) {
        percent = 10;
      }
      label = "Cliente frecuente (" + percent + "%)";
    } else {
      // nada
      percent = 0;
      label = "";
    }

    const discountAmount = Math.round(subtotal * (percent / 100));
    const totalAfter = subtotal - discountAmount;

    state.discount = { percent, label };

    return {
      percent,
      label,
      discountAmount,
      totalAfter
    };
  }

  /* ===================== CARRITO ===================== */
  function openCartDrawer() {
    if (cart.length === 0) {
      alert("Tu carrito est√° vac√≠o.");
      return;
    }
    document.getElementById("cart-drawer").classList.add("open");
    document.getElementById("cart-backdrop").style.display = "block";
  }

  function closeCartDrawer() {
    document.getElementById("cart-drawer").classList.remove("open");
    document.getElementById("cart-backdrop").style.display = "none";
  }

  function updateCartUI() {
    const countEl = document.getElementById("cart-count");
    const bodyEl  = document.getElementById("cart-drawer-body");
    const subtotalEl = document.getElementById("cart-drawer-subtotal");
    const discountBox = document.getElementById("cart-drawer-discount");
    const discountAmountEl = document.getElementById("cart-drawer-discount-amount");
    const totalEl = document.getElementById("cart-drawer-total");

    countEl.textContent = cart.length.toString();
    bodyEl.innerHTML = "";

    if (cart.length === 0) {
      bodyEl.innerHTML = '<p class="muted">Tu carrito est√° vac√≠o.</p>';
      subtotalEl.textContent = "‚Ç°0";
      discountBox.style.display = "none";
      totalEl.textContent = "‚Ç°0";
      return;
    }

    cart.forEach(item => {
      const div = document.createElement("div");
      div.className = "cart-item-row";
      const icon = document.createElement("div");
      icon.className = "cart-item-icon";
      icon.textContent = item.icon || "üå≠";
      const main = document.createElement("div");
      main.className = "cart-item-main";
      const nameEl = document.createElement("div");
      nameEl.className = "cart-item-name";
      nameEl.textContent = item.quantity + " x " + item.productName;
      const packEl = document.createElement("div");
      packEl.className = "cart-item-pack";
      packEl.textContent = item.packLabel;
      main.appendChild(nameEl);
      main.appendChild(packEl);
      const priceEl = document.createElement("div");
      priceEl.className = "cart-item-price";
      priceEl.textContent = formatCRC(item.lineTotal);
      div.appendChild(icon);
      div.appendChild(main);
      div.appendChild(priceEl);
      bodyEl.appendChild(div);
    });

    const subtotal = cart.reduce((s, c) => s + c.lineTotal, 0);
    subtotalEl.textContent = formatCRC(subtotal);

    const disc = computeDiscount(subtotal);
    if (disc.percent > 0) {
      discountBox.style.display = "block";
      discountAmountEl.textContent = "- " + formatCRC(disc.discountAmount);
      totalEl.textContent = formatCRC(disc.totalAfter);
    } else {
      discountBox.style.display = "none";
      totalEl.textContent = formatCRC(subtotal);
    }
  }

  /* ===================== SEND ORDER ===================== */
  async function sendOrder() {
    const statusEl = document.getElementById("status");
    const btnNuevo = document.getElementById("btn-nuevo-pedido");
    statusEl.classList.remove("status-box-success");
    btnNuevo.style.display = "none";

    const nombreSeguro = ((state && state.nombre) || "").trim() || "cliente";

    try {
      if (!Array.isArray(cart) || cart.length === 0) {
        statusEl.textContent = "Agreg√° al menos un producto al carrito antes de confirmar.";
        return;
      }

      statusEl.textContent = "Enviando tu pedido, " + nombreSeguro + "...";
      playFeedback("send");

      // Total bruto (antes de cualquier descuento)
      const totalBrutoColones = cart.reduce(
        (suma, item) => suma + Number(item.lineTotal || 0),
        0
      );

      // Por ahora el total cobrado es igual al bruto.
      // Cuando apliquemos PRIMERA15 / descuentos recurrentes,
      // solo ajustamos totalColones, pero dejamos totalBrutoColones intacto.
      let totalColones = totalBrutoColones;

      const discountInfo = computeDiscount(subtotalColones);
      const totalColones = discountInfo.totalAfter;
      const discountAmount = discountInfo.discountAmount;
      const discountLabel = discountInfo.label;
      const discountPercent = discountInfo.percent;

      const cartLines = cart
        .map(item => {
          const qty = item.quantity || 0;
          const name = item.productName || "Producto";
          const pack = item.packLabel || "";
          const lineTotal = Number(item.lineTotal || 0);
          return qty + " x " + name + " (" + pack + ") ‚Äì " + formatCRC(lineTotal);
        })
        .join("\n");

      const presentacionResumen = cart
        .map(item => (item.quantity || 0) + " x " + (item.packLabel || ""))
        .join(", ");

      const pesoTotalGramos = cart.reduce(
        (suma, item) => suma + (Number(item.grams || 0) * Number(item.quantity || 0)),
        0
      );

      const primerProducto = (cart[0] && cart[0].productName) || "Calculadora Monte Alto";

      let comentariosBase = (state && state.comentarios) || "";
      if (discountPercent > 0) {
        comentariosBase += "\nDescuento aplicado: " + discountLabel +
          " (-" + formatCRC(discountAmount) + ")";
        comentariosBase += "\nSubtotal sin descuento: " + formatCRC(subtotalColones);
      }
      if (state.discountCode && state.discountCode !== "PRIMERA15") {
        comentariosBase += "\nC√≥digo de descuento adicional: " + state.discountCode;
      }
      comentariosBase += "\nM√©todo de pago: SINPE m√≥vil BAC";

      const comentariosFinal = comentariosBase + "\n" + cartLines;

      const payload = {
        action: "saveOrder",
        sessionId: sessionId,
        nombre: state.nombre || "",
        telefono: state.telefono || "",
        comentarios: comentariosFinal,
        cantidad: cart.length,
        totalColones: totalColones,           // total cobrado (con descuento)
        totalBrutoColones: totalBrutoColones, // base para puntos
        puntos: 0,
        productoId: primerProducto,
        presentacionResumen: presentacionResumen,
        pesoTotalGramos: pesoTotalGramos,
        discountCode: state.discountCode || "",
        promoAccepted: state.wantsPromos ? "Si" : ""
      };

      const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        statusEl.textContent =
          "Error enviando el pedido (HTTP " + res.status + ": " + res.statusText + "). Verific√° la URL del Apps Script.";
        return;
      }

      let data;
      try {
        data = await res.json();
      } catch (e) {
        statusEl.textContent = "No se pudo interpretar la respuesta del servidor.";
        return;
      }

      if (!data.success) {
        statusEl.textContent =
          (data.message ? data.message : "No se pudo guardar el pedido en la hoja.");
        return;
      }

      const orderId = data.orderId || "";
      const puntosPedido = Number(data.points || data.pointsThisOrder || 0);
      const totalPointsAfter = Number(data.totalPointsAfter || 0);

      burstConfettiBigCenter();

      const resumenHtml = cart
        .map(item =>
          (item.quantity || 0) + " x " + item.productName +
          " (" + item.packLabel + ") ‚Äì " + formatCRC(item.lineTotal)
        )
        .join("<br>");

      // ==== FECHAS: CHORIZO VS BACON ====
      function formatDate(d) {
        return d.toLocaleDateString("es-CR", {
          weekday: "long",
          day: "numeric",
          month: "long"
        });
      }

      const contieneBacon = cart.some(i => i.productId === "bacon");

      const fechaChorizos = getNextSaturday(new Date());
      const fechaChorizosStr = formatDate(fechaChorizos);

      let fechaBacon = new Date();
      fechaBacon.setDate(fechaBacon.getDate() + 10);
      const fechaBaconStr = formatDate(fechaBacon);

      let textoFechas = "";
      if (contieneBacon && cart.length > 1) {
        textoFechas =
          "<strong>Fechas de entrega:</strong><br>" +
          "‚Ä¢ Chorizos: " + fechaChorizosStr + "<br>" +
          "‚Ä¢ Bacon: " + fechaBaconStr + "<br>" +
          "<em>El bacon requiere un proceso m√≠nimo de 10 d√≠as.</em>";
      } else if (contieneBacon) {
        textoFechas =
          "<strong>Fecha estimada de entrega:</strong> " +
          fechaBaconStr +
          "<br><em>El bacon requiere un proceso m√≠nimo de 10 d√≠as.</em>";
      } else {
        textoFechas =
          "<strong>Fecha estimada de entrega:</strong> " + fechaChorizosStr;
      }
      // ==== FIN FECHAS ====

      let extraLoyalty = "";
      if (!isNaN(puntosPedido) && !isNaN(totalPointsAfter)) {
        extraLoyalty =
          "<br><br><strong>Puntos de fidelidad:</strong><br>" +
          "Este pedido te da " + puntosPedido + " puntos.<br>" +
          "Con este pedido llegar√°s a " + totalPointsAfter + " puntos acumulados.";
      }

      let orderLine = "";
      if (orderId) {
        orderLine = "<br><strong>N√∫mero de orden:</strong> " + orderId;
      }

      let descuentoHtml = "";
      if (discountPercent > 0) {
        descuentoHtml =
          "<br><br><strong>Detalle de montos:</strong><br>" +
          "Subtotal: " + formatCRC(subtotalColones) + "<br>" +
          "Descuento " + discountLabel + ": - " + formatCRC(discountAmount) + "<br>" +
          "<strong>Total a pagar:</strong> " + formatCRC(totalColones);
      } else {
        descuentoHtml =
          "<br><br><strong>Total:</strong> " + formatCRC(totalColones);
      }

      const sinpeHtml =
        "<br><br><strong>Pago por SINPE m√≥vil (BAC):</strong><br>" +
        "Envi√° el monto total al n√∫mero <strong>6066-8322</strong> (Marianela Esquivel).<br>" +
        "En el detalle indic√° tu orden #" + (orderId || "(pendiente)") + ".";

      statusEl.innerHTML =
        "¬°Gracias por tu compra, " + nombreSeguro + "! üß°<br><br>" +
        "<strong>Resumen de tu pedido:</strong><br>" +
        resumenHtml +
        orderLine +
        descuentoHtml +
        "<br><br>" +
        textoFechas +
        extraLoyalty +
        sinpeHtml;

      statusEl.classList.add("status-box-success");
      btnNuevo.style.display = "inline-block";

      document.getElementById("label-descuento").style.display = "none";
      document.getElementById("discount-code").style.display = "none";
      document.getElementById("sinpe-box").style.display = "none";
      document.getElementById("chk-promos").disabled = true;
      const promoBox = document.querySelector(".promo-box");
      if (promoBox) promoBox.style.display = "none";
      document.getElementById("btn-volver-productos").style.display = "none";
      document.getElementById("btn-confirmar").style.display = "none";

      // ===== MENSAJE WHATSAPP A TU TEL√âFONO 6022-8322 =====
      const waLines = [];
      waLines.push("Hola, soy " + nombreSeguro + ".");
      waLines.push("Quiero confirmar mi pedido en Monte Alto.");
      waLines.push("");
      if (orderId) {
        waLines.push("Orden #" + orderId);
      }
      waLines.push("Detalle:");
      waLines.push(cartLines);
      waLines.push("");
      if (discountPercent > 0) {
        waLines.push("Subtotal: " + formatCRC(subtotalColones));
        waLines.push("Descuento " + discountLabel + ": - " + formatCRC(discountAmount));
      }
      waLines.push("Total a pagar: " + formatCRC(totalColones));

      // Fechas de entrega (mismo criterio que en la pantalla)
      waLines.push("");
      if (contieneBacon && cart.length > 1) {
        waLines.push("Fechas de entrega:");
        waLines.push("‚Ä¢ Chorizos: " + fechaChorizosStr);
        waLines.push("‚Ä¢ Bacon: " + fechaBaconStr + " (el bacon requiere un proceso m√≠nimo de 10 d√≠as).");
      } else if (contieneBacon) {
        waLines.push("Fecha estimada de entrega: " + fechaBaconStr + " (el bacon requiere un proceso m√≠nimo de 10 d√≠as).");
      } else {
        waLines.push("Fecha estimada de entrega: " + fechaChorizosStr);
      }

      // Puntos
      if (!isNaN(puntosPedido)) {
        waLines.push("");
        waLines.push("Puntos de fidelidad:");
        waLines.push("Este pedido me da " + puntosPedido + " puntos.");
      }
      if (!isNaN(totalPointsAfter)) {
        waLines.push("Con este pedido llegar√© a " + totalPointsAfter + " puntos acumulados.");
      }

      // Datos de SINPE
      waLines.push("");
      waLines.push("Pago por SINPE m√≥vil (BAC):");
      waLines.push("Env√≠o el monto total al n√∫mero 6066-8322 (Marianela Esquivel).");
      if (orderId) {
        waLines.push("En el detalle indico mi orden #" + orderId + ".");
      }

      const waMessage = waLines.join("\n");

      if (isMobileDevice()) {
        const waUrl =
          "https://wa.me/50660228322?text=" + encodeURIComponent(waMessage);
        window.location.href = waUrl;
      }
      // ============================================

      cart = [];
      updateCartUI();

    } catch (err) {
      console.error("Error en sendOrder():", err);
      const statusEl2 = document.getElementById("status");
      statusEl2.textContent =
        "Hubo un problema enviando tu pedido.\nDetalle t√©cnico: " +
        (err && err.message ? err.message : String(err));
    }
  }

  /* ===================== RESET ===================== */
  function resetForNewOrder() {
    sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;

    state.nombre = "";
    state.telefono = "";
    state.comentarios = "";
    state.discountCode = "";
    state.currentProductId = "";
    state.currentWeightId = "";
    state.currentQuantity = 1;
    state.wantsPromos = false;
    state.pointsChecked = false;
    state.customerProfile = {
      pointsBefore: 0,
      totalOrders: 0,
      usedFirstDiscount: false,
      lastProduct: "",
      lastPresentacion: ""
    };
    state.discount = { percent: 0, label: "" };

    cart = [];
    updateCartUI();

    document.getElementById("nombre").value = "";
    document.getElementById("telefono").value = "";
    document.getElementById("comentarios").value = "";
    document.getElementById("discount-code").value = "";
    document.getElementById("datos-error").textContent = "";
    document.getElementById("puntos-info").textContent = "";
    document.getElementById("recom-info").textContent = "";
    document.getElementById("puntos-info").classList.remove("has-points", "no-points");
    document.getElementById("subtotal-linea").textContent = "‚Ç°0";
    document.getElementById("producto").value = "";
    document.getElementById("peso").value = "";
    document.getElementById("cantidad").value = 1;
    document.getElementById("product-image-wrapper").style.display = "none";

    const statusEl = document.getElementById("status");
    statusEl.textContent = "";
    statusEl.classList.remove("status-box-success");
    document.getElementById("btn-nuevo-pedido").style.display = "none";

    document.getElementById("chk-promos").checked = false;
    document.getElementById("chk-promos").disabled = false;
    const promoBox = document.querySelector(".promo-box");
    if (promoBox) promoBox.style.display = "";

    document.getElementById("step-datos").classList.add("active");
    document.getElementById("step-producto").classList.remove("active");
    document.getElementById("step-cliente").classList.remove("active");

    document.getElementById("label-descuento").style.display = "";
    document.getElementById("discount-code").style.display = "";
    document.getElementById("sinpe-box").style.display = "";
    document.getElementById("btn-volver-productos").style.display = "";
    document.getElementById("btn-confirmar").style.display = "";

    updateContinueButtonState();
  }

  /* ===================== RESUMEN FINAL (no se usa caja aparte) ===================== */
  function updateResumenFinal() {
    // Intencionalmente vac√≠o: usamos solo el status final y el drawer.
  }

  /* ===================== BOT√ìN CONTINUAR ===================== */
  function updateContinueButtonState() {
    const btn = document.getElementById("btn-ir-productos");
    const nombreInput = document.getElementById("nombre");
    const telInput = document.getElementById("telefono");

    const n = (nombreInput.value || "").trim();
    const t = (telInput.value || "").replace(/\D/g, "").trim();

    const can =
      n.length > 0 &&
      t.length >= 8 &&
      state.pointsChecked === true;

    btn.disabled = !can;
  }

  /* ===================== SETUP ===================== */
  function setup() {
    const productoSelect = document.getElementById("producto");
    const pesoSelect = document.getElementById("peso");
    const telInput = document.getElementById("telefono");
    const nombreInput = document.getElementById("nombre");
    const discountInput = document.getElementById("discount-code");
    const chkPromos = document.getElementById("chk-promos");
    const btnNuevo = document.getElementById("btn-nuevo-pedido");

    CONFIG.products.forEach(p => {
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      productoSelect.appendChild(o);
    });

    CONFIG.weights.forEach(w => {
      const o = document.createElement("option");
      o.value = w.id;
      o.textContent = w.label;
      pesoSelect.appendChild(o);
    });

    let lastPointsPhone = "";
    telInput.addEventListener("input", () => {
      const raw   = telInput.value || "";
      const clean = raw.replace(/\D/g, "").trim();
      if (clean.length >= 8 && clean !== lastPointsPhone) {
        lastPointsPhone = clean;
        fetchPointsForPhone(clean);
      } else if (clean.length < 8) {
        const infoEl = document.getElementById("puntos-info");
        infoEl.textContent = "";
        infoEl.classList.remove("has-points", "no-points");
        document.getElementById("recom-info").textContent = "";
        lastPointsPhone = "";
        state.pointsChecked = false;
        updateContinueButtonState();
      }
    });

    nombreInput.addEventListener("input", () => {
      updateContinueButtonState();
    });

    discountInput.addEventListener("input", () => {
      discountInput.value = discountInput.value.toUpperCase();
    });

    chkPromos.addEventListener("change", () => {
      state.wantsPromos = chkPromos.checked;
    });

    document.getElementById("btn-ir-productos").onclick = () => {
      const n = nombreInput.value.trim();
      const t = telInput.value.trim();
      const err = document.getElementById("datos-error");
      if (!n) {
        err.textContent = "Ingres√° tu nombre.";
        return;
      }
      if (!t || t.replace(/\D/g, "").length < 8) {
        err.textContent = "Tel√©fono inv√°lido.";
        return;
      }
      if (!state.pointsChecked) {
        err.textContent = "Esper√° un momento mientras revisamos tus puntos.";
        return;
      }
      err.textContent = "";
      state.nombre = n;
      state.telefono = t;
      document.getElementById("step-datos").classList.remove("active");
      document.getElementById("step-producto").classList.add("active");
    };

    productoSelect.onchange = () => {
      state.currentProductId = productoSelect.value;
      const p = getSelectedProduct();
      const imgWrap = document.getElementById("product-image-wrapper");
      const img = document.getElementById("product-image");
      const caption = document.getElementById("product-image-caption");
      if (p) {
        img.src = p.imageUrl;
        caption.textContent = p.name;
        imgWrap.style.display = "block";
      } else {
        imgWrap.style.display = "none";
        img.src = "";
      }
      document.getElementById("subtotal-linea").textContent =
        formatCRC(calculateSubtotal());
    };

    pesoSelect.onchange = () => {
      state.currentWeightId = pesoSelect.value;
      document.getElementById("subtotal-linea").textContent =
        formatCRC(calculateSubtotal());
    };

    document.getElementById("cantidad").oninput = () => {
      state.currentQuantity =
        Number(document.getElementById("cantidad").value) || 1;
      document.getElementById("subtotal-linea").textContent =
        formatCRC(calculateSubtotal());
    };

    const btnAgregar = document.getElementById("btn-agregar-carrito");
    btnAgregar.onclick = () => {
      const p = getSelectedProduct();
      const w = getSelectedWeight();
      if (!p || !w) {
        alert("Revis√° que escogiste el chorizo/tocineta y el peso.");
        return;
      }
      state.comentarios = document.getElementById("comentarios").value.trim();
      const qty = state.currentQuantity;
      const lineTotal = calculateLineTotal(p, w.grams, qty);
      const icon = p.type === "bacon" ? "ü•ì" : "üå≠";
      cart.push({
        productId: p.id,
        productName: p.name,
        packLabel: w.label,
        grams: w.grams,
        quantity: qty,
        lineTotal: lineTotal,
        icon: icon
      });
      updateCartUI();
      burstConfettiSmallFromElement(btnAgregar);
      playFeedback("add");
      state.currentProductId = "";
      state.currentWeightId = "";
      state.currentQuantity = 1;
      document.getElementById("producto").value = "";
      document.getElementById("peso").value = "";
      document.getElementById("cantidad").value = 1;
      document.getElementById("product-image-wrapper").style.display = "none";
      document.getElementById("subtotal-linea").textContent = "‚Ç°0";
    };

    document.getElementById("btn-comprar-ya").onclick = () => {
      if (cart.length === 0) {
        alert("Agreg√° algo al carrito.");
        return;
      }
      state.comentarios = document.getElementById("comentarios").value.trim();
      document.getElementById("step-producto").classList.remove("active");
      document.getElementById("step-cliente").classList.add("active");
      updateResumenFinal(); // ahora no hace nada visible
    };

    document.getElementById("btn-volver-productos").onclick = () => {
      document.getElementById("step-cliente").classList.remove("active");
      document.getElementById("step-producto").classList.add("active");
    };

    document.getElementById("btn-confirmar").onclick = () => {
      const manualCode = document.getElementById("discount-code").value.trim().toUpperCase();
      if (manualCode) {
        state.discountCode = manualCode;
      }
      sendOrder();
    };

    btnNuevo.onclick = resetForNewOrder;

    document.getElementById("cart-icon").onclick = openCartDrawer;
    document.getElementById("cart-backdrop").onclick = closeCartDrawer;
    document.getElementById("btn-cart-close").onclick = closeCartDrawer;

    document.getElementById("btn-go-confirm").onclick = () => {
      if (cart.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }
      closeCartDrawer();
      document.getElementById("step-producto").classList.remove("active");
      document.getElementById("step-cliente").classList.add("active");
      updateResumenFinal();
    };

    // Toggle tema
    document.querySelectorAll(".theme-pill").forEach(pill => {
      pill.addEventListener("click", () => {
        applyTheme(pill.dataset.theme);
      });
    });

    initTheme();
    updateCartUI();
    updateContinueButtonState();
    loadConfigFromSheet();
  }

  window.onload = () => setup();
  </script>

</body>
</html>

