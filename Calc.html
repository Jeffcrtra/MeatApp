<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Monte Alto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --primary: #0b5c89;
      --accent: #ffc107;
      --bg: #f8f9fa;
      --card: #ffffff;
      --danger: #c1121f;
      --muted: #6c757d;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #212529;
    }

    .app {
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
    }

    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }

    .field {
      margin-bottom: 0.75rem;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 0.5rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #ced4da;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: flex;
      gap: 0.5rem;
    }

    .row > .field {
      flex: 1;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15) inset;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-accent {
      background: var(--accent);
      color: #000;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-block {
      width: 100%;
      justify-content: center;
    }

    .status {
      font-size: 0.85rem;
      margin-top: 0.5rem;
      color: var(--muted);
      min-height: 1.2em;
    }

    .status--ok {
      color: #198754;
    }

    .status--error {
      color: var(--danger);
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: #e9ecef;
      font-size: 0.75rem;
    }

    .loyalty {
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .loyalty strong {
      color: #f59f00;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 0.35rem 0;
      border-bottom: 1px dashed #e5e5e5;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-summary {
      margin-top: 0.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      text-align: right;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .order-info {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #198754;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Monte Alto ‚Äì Calculadora 8:15</h1>
    <div class="subtitle">Arma el pedido, calculamos el total y te ayudamos a enviarlo.</div>

    <!-- AUDIO para clicks -->
    <audio id="sound-add" src="click-add.mp3" preload="auto"></audio>
    <audio id="sound-send" src="click-send.mp3" preload="auto"></audio>

    <!-- Datos del cliente -->
    <div class="card">
      <div class="section-title">Datos del cliente</div>
      <div class="field">
        <label for="telefono">Tel√©fono (WhatsApp)</label>
        <input id="telefono" type="tel" inputmode="tel" placeholder="Ej: 6066-8322" />
        <div id="loyaltyInfo" class="loyalty"></div>
      </div>
      <div class="field">
        <label for="nombre">Nombre</label>
        <input id="nombre" type="text" placeholder="Tu nombre" />
      </div>
      <div class="field">
        <label for="comentarios">Comentarios (direcci√≥n, indicaciones, etc.)</label>
        <textarea id="comentarios" placeholder="Opcional"></textarea>
      </div>
      <div id="clientStatus" class="status"></div>
    </div>

    <!-- Selector de productos -->
    <div class="card">
      <div class="section-title">Agregar productos</div>
      <div class="field">
        <label for="producto">Producto</label>
        <select id="producto">
          <option value="">Selecciona un producto</option>
          <option value="Tex-Mex">Chorizo Tex-Mex</option>
          <option value="Caribe√±o">Chorizo Caribe√±o</option>
          <option value="Criollo">Chorizo Criollo Argentino</option>
          <option value="Bratwurst">Bratwurst</option>
        </select>
      </div>
      <div class="row">
        <div class="field">
          <label for="presentacion">Presentaci√≥n</label>
          <select id="presentacion">
            <option value="">Selecciona</option>
            <option value="Tripa natural">Tripa natural</option>
            <option value="Bomba">Bomba</option>
          </select>
        </div>
        <div class="field">
          <label for="cantidad">Cantidad (unidades)</label>
          <input id="cantidad" type="number" min="1" step="1" value="1" />
        </div>
      </div>
      <div class="field">
        <label for="precio">Precio por unidad (‚Ç°)</label>
        <input id="precio" type="number" min="0" step="1" value="0" />
        <div class="hint">Pod√©s dejarlo fijo o ajustarlo seg√∫n promoci√≥n.</div>
      </div>
      <button id="btnAddToCart" class="btn btn-accent btn-block">
        ‚ûï Agregar al carrito
      </button>
      <div id="productStatus" class="status"></div>
    </div>

    <!-- Carrito -->
    <div class="card">
      <div class="section-title">Carrito</div>
      <div id="cartList"></div>
      <div id="cartSummary" class="cart-summary"></div>
      <button id="btnClearCart" class="btn btn-danger btn-block" style="margin-top:0.5rem;">
        Vaciar carrito
      </button>
    </div>

    <!-- Env√≠o del pedido -->
    <div class="card">
      <div class="section-title">Enviar pedido</div>
      <button id="btnSendOrder" class="btn btn-primary btn-block">
        üßæ Enviar pedido
      </button>
      <div id="orderStatus" class="status"></div>
      <div id="orderInfo" class="order-info"></div>
    </div>
  </div>

  <script>
    // ========================
    // CONFIGURACI√ìN
    // ========================
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbx56k2TGXnhTVCySf9ikQP-_u91aYb-8wiK-yxQGknJTI4qJZIslZZOHvdSvgYGZQyP/exec';
    const WHATSAPP_NUMBER = '50660668322'; // Cambia si es necesario

    let sessionId = generateSessionId_();

    const state = {
      cart: [],
      loyalty: {
        totalPoints: 0,
        orderCount: 0
      }
    };

    // ========================
    // UTILIDADES
    // ========================
    function generateSessionId_() {
      return 'sess-' + Math.random().toString(36).substring(2) + Date.now().toString(36);
    }

    function playFeedback(type) {
      let audioId = type === 'send' ? 'sound-send' : 'sound-add';
      const audio = document.getElementById(audioId);
      if (audio) {
        try {
          audio.currentTime = 0;
          audio.play().catch(() => {});
        } catch (e) {}
      }
      if (navigator.vibrate) {
        navigator.vibrate(30);
      }
    }

    function isMobile_() {
      return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    }

    function formatColones(n) {
      n = Number(n) || 0;
      return n.toLocaleString('es-CR');
    }

    function setStatus(el, msg, type) {
      el.textContent = msg || '';
      el.classList.remove('status--ok', 'status--error');
      if (type === 'ok') el.classList.add('status--ok');
      if (type === 'error') el.classList.add('status--error');
    }

    function buildCartTextForMessage(cart) {
      if (!cart.length) return '';
      return cart.map(item =>
        `‚Ä¢ ${item.producto} (${item.presentacion}) x ${item.cantidad} = ‚Ç°${formatColones(item.subtotal)}`
      ).join('\n');
    }

    // ========================
    // LOYALTY: obtener puntos del cliente
    // ========================
    async function fetchClientInfo(telefono) {
      const clientStatus = document.getElementById('clientStatus');
      const loyaltyInfo = document.getElementById('loyaltyInfo');

      if (!telefono) {
        state.loyalty.totalPoints = 0;
        state.loyalty.orderCount = 0;
        loyaltyInfo.textContent = '';
        setStatus(clientStatus, '', '');
        return;
      }

      setStatus(clientStatus, 'Buscando tus puntos acumulados...', '');
      loyaltyInfo.textContent = '';

      try {
        const payload = {
          action: 'getClientInfo',
          telefono: telefono
        };

        const resp = await fetch(ENDPOINT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        const data = await resp.json();

        if (!data.success) {
          setStatus(clientStatus, data.message || 'No se pudo obtener la informaci√≥n del cliente.', 'error');
          return;
        }

        state.loyalty.totalPoints = Number(data.totalPoints || 0);
        state.loyalty.orderCount = Number(data.orderCount || 0);

        setStatus(clientStatus, '', '');
        if (data.orderCount > 0) {
          loyaltyInfo.innerHTML =
            `Ten√©s actualmente ‚≠ê <strong>${state.loyalty.totalPoints}</strong> puntos acumulados<br>` +
            `<span class="hint">Este es tu pedido #${state.loyalty.orderCount + 1} con este n√∫mero.</span>`;
        } else {
          loyaltyInfo.innerHTML =
            `üéâ Este ser√≠a tu primer pedido. Los puntos empiezan a acumularse desde hoy.`;
        }
      } catch (err) {
        console.error(err);
        setStatus(clientStatus, 'Error de conexi√≥n al consultar tus puntos.', 'error');
      }
    }

    // ========================
    // CARRITO
    // ========================
    function renderCart() {
      const cartList = document.getElementById('cartList');
      const cartSummary = document.getElementById('cartSummary');
      const cart = state.cart;

      cartList.innerHTML = '';

      if (!cart.length) {
        cartList.innerHTML = '<div class="hint">A√∫n no hay productos en el carrito.</div>';
        cartSummary.textContent = '';
        return;
      }

      let total = 0;

      cart.forEach((item, idx) => {
        total += item.subtotal;
        const row = document.createElement('div');
        row.className = 'cart-item';

        const left = document.createElement('div');
        left.textContent = `${item.producto} (${item.presentacion}) x ${item.cantidad}`;

        const right = document.createElement('div');
        right.textContent = `‚Ç°${formatColones(item.subtotal)}`;

        row.appendChild(left);
        row.appendChild(right);
        cartList.appendChild(row);
      });

      cartSummary.textContent = `Total: ‚Ç°${formatColones(total)}`;
    }

    function addToCart() {
      const productStatus = document.getElementById('productStatus');

      const producto = document.getElementById('producto').value;
      const presentacion = document.getElementById('presentacion').value;
      const cantidad = Number(document.getElementById('cantidad').value || 0);
      const precio = Number(document.getElementById('precio').value || 0);

      if (!producto || !presentacion || cantidad <= 0 || precio <= 0) {
        setStatus(productStatus, 'Revis√° producto, presentaci√≥n, cantidad y precio.', 'error');
        return;
      }

      playFeedback('add');

      const subtotal = cantidad * precio;
      state.cart.push({
        producto,
        presentacion,
        cantidad,
        precio,
        subtotal
      });

      setStatus(productStatus, 'Producto agregado al carrito.', 'ok');
      renderCart();

      // Limpiar campos de producto
      document.getElementById('producto').value = '';
      document.getElementById('presentacion').value = '';
      document.getElementById('cantidad').value = 1;
      document.getElementById('precio').value = 0;
    }

    function clearCart() {
      state.cart = [];
      renderCart();
      setStatus(document.getElementById('productStatus'), 'Carrito vac√≠o.', '');
    }

    // ========================
    // ENVIAR PEDIDO
    // ========================
    async function sendOrder() {
      const orderStatus = document.getElementById('orderStatus');
      const orderInfo = document.getElementById('orderInfo');

      const telefono = document.getElementById('telefono').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const comentarios = document.getElementById('comentarios').value.trim();

      if (!telefono) {
        setStatus(orderStatus, 'Necesitamos el tel√©fono para poder enviarte el pedido por WhatsApp.', 'error');
        return;
      }

      if (!state.cart.length) {
        setStatus(orderStatus, 'Agreg√° al menos un producto al carrito.', 'error');
        return;
      }

      playFeedback('send');

      // Total y detalle
      let total = 0;
      const cartLines = state.cart.map(item => {
        total += item.subtotal;
        return `${item.producto} (${item.presentacion}) x ${item.cantidad} = ‚Ç°${formatColones(item.subtotal)}`;
      }).join('\n');

      const payload = {
        action: 'saveOrder',
        sessionId: sessionId,
        telefono: telefono,
        nombre: nombre,
        comentarios: (comentarios || '') + '\n' + cartLines,
        cantidad: state.cart.length,
        totalColones: total
      };

      setStatus(orderStatus, 'Guardando tu pedido...', '');
      orderInfo.textContent = '';

      try {
        const resp = await fetch(ENDPOINT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if (!data.success) {
          setStatus(orderStatus, data.message || 'No se pudo guardar el pedido.', 'error');
          return;
        }

        const orderId = data.orderId;
        const pointsThisOrder = Number(data.pointsThisOrder || 0);
        const totalPointsAfter = Number(data.totalPointsAfter || 0);

        setStatus(orderStatus, 'Pedido guardado correctamente ‚úÖ', 'ok');

        const resumenPoints = `Este pedido te da ‚≠ê ${pointsThisOrder} puntos.\nCon este pedido llegar√°s a ‚≠ê ${totalPointsAfter} puntos acumulados.`;

        orderInfo.innerHTML =
          `Pedido <strong>#${orderId}</strong> registrado.<br>` +
          resumenPoints.replace('\n', '<br>');

        // Actualizar estado de loyalty en cliente
        state.loyalty.totalPoints = totalPointsAfter;

        // Construir mensaje de WhatsApp
        const header = `Hola, soy ${nombre || 'cliente'}.`;
        const intro = `Quiero hacer el siguiente pedido de Monte Alto:`;
        const totalLine = `Total: ‚Ç°${formatColones(total)}.`;
        const orderLine = `Pedido #${orderId}.`;
        const pointsLine1 = `Este pedido me da ${pointsThisOrder} puntos.`;
        const pointsLine2 = `Con este pedido llegar√© a ${totalPointsAfter} puntos acumulados.`;

        const fullMessage =
          `${header}\n` +
          `${intro}\n\n` +
          `${buildCartTextForMessage(state.cart)}\n\n` +
          `${totalLine}\n${orderLine}\n\n` +
          `${pointsLine1}\n${pointsLine2}\n\n` +
          (comentarios ? `Notas: ${comentarios}` : '');

        if (isMobile_()) {
          const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(fullMessage)}`;
          window.open(url, '_blank');
        } else {
          // En desktop, solo le mostramos el texto para copiar
          orderInfo.innerHTML +=
            `<br><br><span class="hint">Est√°s en computadora. Copi√° este mensaje y pegalo en WhatsApp:</span><br>` +
            `<textarea style="width:100%;margin-top:0.5rem;" rows="6">${fullMessage}</textarea>`;
        }

        // Opcional: limpiar carrito despu√©s de enviar
        state.cart = [];
        renderCart();

      } catch (err) {
        console.error(err);
        setStatus(orderStatus, 'Error de conexi√≥n al guardar tu pedido.', 'error');
      }
    }

    // ========================
    // INIT
    // ========================
    document.addEventListener('DOMContentLoaded', () => {
      const telefonoInput = document.getElementById('telefono');
      telefonoInput.addEventListener('blur', () => {
        const tel = telefonoInput.value.trim();
        fetchClientInfo(tel);
      });

      document.getElementById('btnAddToCart').addEventListener('click', addToCart);
      document.getElementById('btnClearCart').addEventListener('click', clearCart);
      document.getElementById('btnSendOrder').addEventListener('click', sendOrder);

      renderCart();
    });
  </script>
</body>
</html>
