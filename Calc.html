<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Monte Alto ‚Äì Calculadora de Embutidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111827;
      color: #f9fafb;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      max-width: 680px;
      margin: 0 auto;
      background: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
      color: #d1d5db;
      font-size: 0.9rem;
    }

    select, input, button, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.55rem 0.8rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #0f172a;
      color: #f9fafb;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button.primary {
      background: #2563eb;
      color: white;
    }

    button.secondary {
      background: #374151;
      color: white;
    }

    /* BOT√ìN AMARILLO */
    #btn-agregar-carrito {
      background: #fbbf24;
      color: #111827;
      font-weight: 700;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .summary-box {
      background: #030712;
      border: 1px dashed #4b5563;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .row {
      display: flex;
      gap: 0.75rem;
    }

    .row > div {
      flex: 1;
    }

    .product-image-wrapper {
      text-align: center;
      margin-top: 0.5rem;
      display: none;
    }

    .product-image-wrapper img {
      max-width: 100%;
      border-radius: 0.75rem;
      border: 1px solid #374151;
    }

    .cart-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .cart-table th {
      border-bottom: 1px solid #4b5563;
      color: #d1d5db;
      text-align: left;
      padding-bottom: 0.25rem;
    }

    .cart-table td {
      padding: 0.25rem 0;
      border-bottom: 1px solid #111827;
    }

    .muted { color:#6b7280; font-size:0.85rem; }

    .error-text { color:#fecaca; font-size:0.9rem; min-height:1em; }

    #status { white-space:pre-line; margin-top:0.75rem; }

  </style>
</head>

<body>
  <h1>Monte Alto ‚Äì Calculadora</h1>

  <div class="card">

    <!-- PASO 1: DATOS -->
    <div id="step-datos" class="step active">
      <h3>Paso 1 ¬∑ Tus datos</h3>

      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Tu nombre" />
        </div>

        <div>
          <label>Tel√©fono</label>
          <input id="telefono" type="tel" placeholder="Ej: 12345678" />
        </div>
      </div>

      <div id="datos-error" class="error-text"></div>

      <button id="btn-ir-productos" class="primary">Continuar</button>
    </div>

    <!-- PASO 2: PRODUCTOS -->
    <div id="step-producto" class="step">
      <h3>Paso 2 ¬∑ Escog√© tu embutido</h3>

      <label>Tipo de embutido</label>
      <select id="producto">
        <option value="">‚Äî Selecciona un producto ‚Äî</option>
      </select>

      <div class="product-image-wrapper" id="product-image-wrapper">
        <img id="product-image" src="" />
        <div class="muted" id="product-image-caption"></div>
      </div>

      <label>Presentaci√≥n</label>
      <select id="presentacion">
        <option value="">Selecciona la presentaci√≥n...</option>
      </select>

      <label>N√∫mero de paquetes</label>
      <input id="cantidad" type="number" min="1" value="1"/>

      <div class="summary-box">
        Subtotal: <strong id="subtotal-linea">‚Ç°0</strong>
      </div>

      <button id="btn-agregar-carrito">Agregar al carrito</button>
      <button id="btn-comprar-ya" class="primary">Comprar de una vez</button>
    </div>

    <!-- PASO 3: CONFIRMAR -->
    <div id="step-cliente" class="step">
      <h3>Paso 3 ¬∑ Confirmaci√≥n del pedido</h3>

      <label>Notas (opcional)</label>
      <textarea id="comentarios" rows="3" placeholder="Ej: Entregar en la tarde"></textarea>

      <div id="resumen-final" class="summary-box"></div>

      <button id="btn-volver-productos" class="secondary">Volver</button>
      <button id="btn-confirmar" class="primary">Confirmar pedido</button>

      <div id="status" class="muted"></div>
    </div>

    <!-- CARRITO -->
    <div id="cart-panel" class="summary-box">
      <h3>Carrito</h3>
      <table class="cart-table">
        <thead>
          <tr><th>Producto</th><th>Presentaci√≥n</th><th>Cant</th><th>Subtotal</th></tr>
        </thead>
        <tbody id="cart-body">
          <tr><td colspan="4" class="muted">Sin productos todav√≠a.</td></tr>
        </tbody>
      </table>

      <div class="cart-total">
        Total: <strong id="cart-total">‚Ç°0</strong>
      </div>
    </div>

  </div>


<script>
/* ---------------------------------------------------------
   CONFIG
--------------------------------------------------------- */
const CONFIG = {
  SHEETS_ENDPOINT:
    "https://script.google.com/macros/s/AKfycbzqWLox1-m6wN-Jn_aZ9SCNOpeZfsrv8NNLvX0Inh1vJX6DmpS5XAsH3EeIqwqUrFs2/exec",

  POINTS_PER_1000: 10,

  products: [
    {
      id: "brat",
      name: "Chorizo Bratwurst",
      imageUrl: "Bratwurst.png",
      presentations: [
        { id: "medio", label: "¬Ω kilo (500g)", grams: 500, pricePerKg: 7800 },
        { id: "kilo",  label: "1 kilo (1000g)", grams:1000, pricePerKg: 7500 }
      ]
    },
    {
      id: "tex",
      name: "Chorizo Tex-Mex",
      imageUrl: "Tex-Mex.png",
      presentations: [
        { id: "medio", label: "¬Ω kilo (500g)", grams:500, pricePerKg: 7900 },
        { id: "kilo",  label: "1 kilo (1000g)", grams:1000, pricePerKg: 7600 }
      ]
    },
    {
      id: "criollo",
      name: "Criollo argentino",
      imageUrl: "Argentino.png",
      presentations: [
        { id: "medio", label: "¬Ω kilo (500g)", grams:500, pricePerKg: 8000 },
        { id: "kilo",  label: "1 kilo (1000g)", grams:1000, pricePerKg: 7800 }
      ]
    },
    {
      id: "carib",
      name: "Chorizo Caribe√±o",
      imageUrl: "Caribe√±o.png",
      presentations: [
        { id: "medio", label: "¬Ω kilo (500g)", grams:500, pricePerKg: 7900 },
        { id: "kilo",  label: "1 kilo (1000g)", grams:1000, pricePerKg: 7700 }
      ]
    },
    {
      id: "tico",
      name: "Costarricense casero",
      imageUrl: "Criollo.png",
      presentations: [
        { id: "medio", label:"¬Ω kilo (500g)", grams:500, pricePerKg: 7800 },
        { id: "kilo",  label:"1 kilo (1000g)", grams:1000, pricePerKg:7600 }
      ]
    },
    {
      id:"bacon",
      name:"Bacon Ahumado",
      imageUrl:"Tocineta.png",
      presentations:[
        { id:"medio", label:"¬Ω kilo (500g)", grams:500, pricePerKg:12000 },
        { id:"kilo",  label:"1 kilo (1000g)", grams:1000, pricePerKg:11500 }
      ]
    }
  ]
};


/* ---------------------------------------------------------
   ESTADO
--------------------------------------------------------- */
let sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
let cart = [];

const state = {
  nombre:"",
  telefono:"",
  comentarios:"",
  currentProductId:"",
  currentPresentationId:"",
  currentQuantity:1,
};


/* ---------------------------------------------------------
   UTILIDADES
--------------------------------------------------------- */
function formatCRC(v){ return "‚Ç°"+(v||0).toLocaleString("es-CR"); }
function getSelectedProduct(){
  return CONFIG.products.find(p=>p.id===state.currentProductId) || null;
}
function getSelectedPresentation(){
  const p=getSelectedProduct();
  return p ? p.presentations.find(x=>x.id===state.currentPresentationId) : null;
}
function calculateSubtotal(){
  const pr=getSelectedPresentation();
  if(!pr) return 0;
  const kg = pr.grams /1000;
  return Math.round(pr.pricePerKg * kg * state.currentQuantity);
}


/* ---------------------------------------------------------
   LOG (DESACTIVADO)
--------------------------------------------------------- */
const ENABLE_LOGS = false;
function logEvent(event, data){
  if(!ENABLE_LOGS) return;
  fetch(CONFIG.SHEETS_ENDPOINT, {
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"logEvent",
      sessionId,
      event,
      timestamp:new Date(),
      data:JSON.stringify(data||{})
    })
  });
}


/* ---------------------------------------------------------
   UI ENV√çO
--------------------------------------------------------- */
async function sendOrder(){
  const statusEl=document.getElementById("status");
  const nombreSeguro=(state.nombre||"").trim();

  statusEl.textContent = `Enviando tu pedido, ${nombreSeguro}...`;

  const total = cart.reduce((s,c)=>s+c.lineTotal,0);

  const cartLines = cart
    .map(i=>`${i.quantity} x ${i.productName} (${i.presentationLabel}) ‚Äì ${formatCRC(i.lineTotal)}`)
    .join("\n");

  const payload = {
    action:"saveOrder",
    sessionId,
    productoId:"MULTIPLE",
    nombre:state.nombre,
    telefono:state.telefono,
    comentarios: state.comentarios + "\n" + cartLines,
    cantidad: cart.length,
    totalColones: total,
    puntos: 0
  };

  try{
    await fetch(CONFIG.SHEETS_ENDPOINT,{
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    statusEl.textContent =
      `Hola ${nombreSeguro}, tu compra fue registrada correctamente. üéâ\n`+
      `Te contactaremos por WhatsApp para confirmar.`;

    const mensaje = encodeURIComponent(
      `Hola Monte Alto, soy ${state.nombre} (${state.telefono}).\n`+
      `Pedido:\n${cartLines}\n\nTotal estimado: ${formatCRC(total)}`
    );

    const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile/i.test(navigator.userAgent);
    if(isMobile){
      window.open(`https://wa.me/50660228322?text=${mensaje}`,"_blank");
    } else {
      statusEl.textContent +=
        `\n\nNota: Est√°s en computadora, por eso no se abri√≥ WhatsApp autom√°ticamente.`;
    }

  }catch(e){
    statusEl.textContent="Error al enviar el pedido.";
  }
}


/* ---------------------------------------------------------
   SETUP
--------------------------------------------------------- */
function setup(){
  const productoSelect = document.getElementById("producto");
  CONFIG.products.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent=p.name;
    productoSelect.appendChild(o);
  });

  document.getElementById("btn-ir-productos").onclick = ()=>{
    const n=document.getElementById("nombre").value.trim();
    const t=document.getElementById("telefono").value.trim();
    const err=document.getElementById("datos-error");

    if(!n){ err.textContent="Ingres√° tu nombre."; return; }
    if(!t || t.length<8){ err.textContent="Tel√©fono inv√°lido."; return; }

    state.nombre=n;
    state.telefono=t;

    document.getElementById("step-datos").classList.remove("active");
    document.getElementById("step-producto").classList.add("active");
  };

  productoSelect.onchange = ()=>{
    state.currentProductId = productoSelect.value;
    const p = getSelectedProduct();

    const imgWrap=document.getElementById("product-image-wrapper");
    const img=document.getElementById("product-image");
    const caption=document.getElementById("product-image-caption");

    if(p){
      img.src=p.imageUrl;
      caption.textContent=p.name;
      imgWrap.style.display="block";
    } else {
      imgWrap.style.display="none";
      img.src="";
    }

    const sel=document.getElementById("presentacion");
    sel.innerHTML='<option value="">Selecciona la presentaci√≥n...</option>';
    if(p){
      p.presentations.forEach(pr=>{
        const o=document.createElement("option");
        o.value=pr.id;
        o.textContent=pr.label;
        sel.appendChild(o);
      });
    }
  };

  document.getElementById("presentacion").onchange = ()=>{
    state.currentPresentationId = document.getElementById("presentacion").value;
    document.getElementById("subtotal-linea").textContent =
      formatCRC(calculateSubtotal());
  };

  document.getElementById("cantidad").oninput = ()=>{
    state.currentQuantity = Number(document.getElementById("cantidad").value)||1;
    document.getElementById("subtotal-linea").textContent =
      formatCRC(calculateSubtotal());
  };


  /* ----- AGREGAR AL CARRITO ----- */
  document.getElementById("btn-agregar-carrito").onclick = ()=>{
    const p=getSelectedProduct();
    const pr=getSelectedPresentation();
    if(!p || !pr){
      alert("Revis√° producto y presentaci√≥n.");
      return;
    }
    const qty = state.currentQuantity;
    const lineTotal = calculateSubtotal();

    cart.push({
      productId:p.id,
      productName:p.name,
      presentationId:pr.id,
      presentationLabel:pr.label,
      quantity:qty,
      lineTotal
    });

    updateCartTable();

    // limpiar selecciones
    state.currentProductId="";
    state.currentPresentationId="";
    state.currentQuantity=1;

    document.getElementById("producto").value="";
    document.getElementById("presentacion").innerHTML =
      '<option value="">Selecciona la presentaci√≥n...</option>';
    document.getElementById("cantidad").value=1;
    document.getElementById("product-image-wrapper").style.display="none";
    document.getElementById("subtotal-linea").textContent="‚Ç°0";
  };


  /* ----- COMPRAR YA ----- */
  document.getElementById("btn-comprar-ya").onclick = ()=>{
    if(cart.length===0){
      alert("Agreg√° algo al carrito.");
      return;
    }

    document.getElementById("step-producto").classList.remove("active");
    document.getElementById("step-cliente").classList.add("active");
    updateResumenFinal();
  };


  /* ----- VOLVER ----- */
  document.getElementById("btn-volver-productos").onclick = ()=>{
    document.getElementById("step-cliente").classList.remove("active");
    document.getElementById("step-producto").classList.add("active");
  };


  /* ----- CONFIRMAR ----- */
  document.getElementById("btn-confirmar").onclick = ()=>{
    state.comentarios=document.getElementById("comentarios").value.trim();
    sendOrder();
  };
}


/* ---------------------------------------------------------
   ACTUALIZADORES DE UI
--------------------------------------------------------- */
function updateCartTable(){
  const body=document.getElementById("cart-body");
  body.innerHTML="";

  if(cart.length===0){
    body.innerHTML='<tr><td colspan="4" class="muted">Sin productos todav√≠a.</td></tr>';
    document.getElementById("cart-total").textContent="‚Ç°0";
    return;
  }

  cart.forEach(i=>{
    const tr=document.createElement("tr");
    tr.innerHTML =
      `<td>${i.productName}</td>
       <td>${i.presentationLabel}</td>
       <td>${i.quantity}</td>
       <td>${formatCRC(i.lineTotal)}</td>`;
    body.appendChild(tr);
  });

  const total = cart.reduce((s,c)=>s+c.lineTotal,0);
  document.getElementById("cart-total").textContent = formatCRC(total);
}


function updateResumenFinal(){
  const total = cart.reduce((s,c)=>s+c.lineTotal,0);
  const list = cart.map(i =>
    `${i.quantity} x ${i.productName} (${i.presentationLabel}) ‚Äì ${formatCRC(i.lineTotal)}`
  ).join("<br>");

  document.getElementById("resumen-final").innerHTML =
    `<strong>Resumen de tu compra:</strong><br>${list}<br><br>
     <strong>Total:</strong> ${formatCRC(total)}`;
}


/* ---------------------------------------------------------
   INICIAR
--------------------------------------------------------- */
window.onload = ()=> setup();

</script>

</body>
</html>
