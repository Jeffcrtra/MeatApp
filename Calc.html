<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora Monte Alto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PWA meta b√°sicos -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#003366" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #111827;
      color: #f9fafb;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      background: #1f2937;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: #d1d5db;
    }

    select,
    input,
    button,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #111827;
      color: #f9fafb;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
    }

    select:focus,
    input:focus,
    textarea:focus {
      outline: 2px solid #2563eb;
      border-color: transparent;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button.primary {
      background: #2563eb;
    }

    button.secondary {
      background: #374151;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .step {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #111827;
      border: 1px solid #374151;
      display: none; /* Se muestran din√°micamente */
    }

    .step.active {
      display: block;
    }

    .step-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    .product-image-wrapper {
      text-align: center;
      margin: 0.5rem 0 0.75rem;
    }

    .product-image-wrapper img {
      max-width: 100%;
      border-radius: 0.75rem;
      border: 1px solid #374151;
    }

    .summary-box {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #030712;
      border: 1px dashed #4b5563;
      font-size: 0.9rem;
    }

    .points {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .points strong {
      color: #fbbf24;
    }

    .promo-optin {
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: #020617;
      border: 1px solid #4b5563;
      font-size: 0.85rem;
    }

    .promo-optin label.inline {
      display: inline-flex;
      align-items: center;
      margin-right: 1rem;
      font-size: 0.85rem;
    }

    .promo-optin input[type="radio"] {
      width: auto;
      margin-right: 0.25rem;
      margin-bottom: 0;
    }

    .small {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .actions button {
      flex: 1;
    }

    .status {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #a5b4fc;
      min-height: 1em;
    }

    .error {
      color: #fecaca;
    }
  </style>
</head>
<body>
  <h1>Monte Alto ‚Äì Calculadora</h1>
  <div class="card">
    <!-- STEP 1: Producto -->
    <div class="step active" id="step-producto">
      <div class="step-title">Paso 1 ¬∑ Escog√© tu embutido</div>
      <label for="producto">Tipo de embutido</label>
      <select id="producto">
        <option value="">Selecciona un producto...</option>
      </select>

      <div class="product-image-wrapper" id="product-image-wrapper" style="display:none;">
        <img id="product-image" src="" alt="Producto Monte Alto" />
      </div>
    </div>

    <!-- STEP 2: Presentaci√≥n / gramos / cantidad -->
    <div class="step" id="step-detalle">
      <div class="step-title">Paso 2 ¬∑ Detalle del pedido</div>

      <label for="presentacion">Presentaci√≥n</label>
      <select id="presentacion">
        <option value="">Selecciona la presentaci√≥n...</option>
      </select>

      <label for="gramos">Cantidad (gramos)</label>
      <input type="number" id="gramos" min="100" step="50" placeholder="Ej: 500" />

      <label for="cantidad">N√∫mero de paquetes</label>
      <input type="number" id="cantidad" min="1" step="1" value="1" />

      <div class="summary-box" id="resumen-precio">
        Total estimado: <strong id="total-colones">‚Ç°0</strong>
      </div>
    </div>

    <!-- STEP 3: Datos del cliente -->
    <div class="step" id="step-cliente">
      <div class="step-title">Paso 3 ¬∑ Tus datos</div>

      <label for="nombre">Nombre</label>
      <input type="text" id="nombre" placeholder="Tu nombre completo" />

      <label for="telefono">N√∫mero de celular</label>
      <input type="tel" id="telefono" placeholder="Ej: 6022-8322" />

      <div class="points" id="points-info" style="display:none;"></div>

      <div class="promo-optin" id="promo-optin-wrapper" style="display:none;">
        <div><strong>¬øQuer√©s recibir promociones por WhatsApp?</strong></div>
        <label class="inline">
          <input type="radio" name="promo_optin" value="SI" /> S√≠, acepto (10 puntos de bienvenida)
        </label>
        <label class="inline">
          <input type="radio" name="promo_optin" value="NO" /> No, gracias
        </label>
        <div class="small">
          Usaremos tu n√∫mero solo para informaci√≥n relacionada con Monte Alto y pod√©s salirte cuando quieras.
        </div>
      </div>

      <label for="comentarios">Notas del pedido (opcional)</label>
      <textarea id="comentarios" rows="2" placeholder="Ej: Entregar en la tarde, poco picante, etc."></textarea>
    </div>

    <!-- STEP 4: Confirmaci√≥n y env√≠o -->
    <div class="step" id="step-confirmacion">
      <div class="step-title">Paso 4 ¬∑ Confirm√° y envi√°</div>

      <div class="summary-box" id="resumen-final">
        <!-- Se llena por JS -->
      </div>

      <div class="actions">
        <button class="secondary" id="btn-atras">Atr√°s</button>
        <button class="primary" id="btn-enviar">Enviar pedido</button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    /************************************************************
     * CONFIG B√ÅSICO
     ************************************************************/
    const CONFIG = {
      SHEETS_ENDPOINT: "https://script.google.com/macros/s/AKfycbzqWLox1-m6wN-Jn_aZ9SCNOpeZfsrv8NNLvX0Inh1vJX6DmpS5XAsH3EeIqwqUrFs2/exec", // <-- Reemplaza esto
      POINTS_PER_1000: 10,
      // Ejemplo de productos. AJUSTA esto a tus productos reales Monte Alto.
      products: [
        {
          id: "chorizo_caribeno",
          name: "Chorizo Caribe√±o",
          imageUrl: "https://via.placeholder.com/400x250?text=Chorizo+Caribeno",
          presentations: [
            { id: "pack_500", label: "Paquete 500 g", gramsDefault: 500, pricePerKg: 7800 },
            { id: "pack_1000", label: "Paquete 1 kg", gramsDefault: 1000, pricePerKg: 7500 }
          ]
        },
        {
          id: "chorizo_criollo",
          name: "Chorizo Criollo",
          imageUrl: "https://via.placeholder.com/400x250?text=Chorizo+Criollo",
          presentations: [
            { id: "pack_400", label: "Paquete 400 g", gramsDefault: 400, pricePerKg: 8000 },
            { id: "pack_800", label: "Paquete 800 g", gramsDefault: 800, pricePerKg: 7800 }
          ]
        }
      ]
    };

    /************************************************************
     * ESTADO GLOBAL
     ************************************************************/
    let sessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    let currentStep = "producto";
    let stepStartTime = performance.now();

    let state = {
      productoId: "",
      presentacionId: "",
      gramos: 0,
      cantidad: 1,
      totalColones: 0,
      nombre: "",
      telefono: "",
      comentarios: "",
      isNewCustomer: null,
      existingPoints: 0,
      promoOptIn: null, // "SI" | "NO" | null
      welcomeBonus: 0,
      totalPointsThisOrder: 0
    };

    /************************************************************
     * UTILIDADES
     ************************************************************/
    function formatMoneyCRC(value) {
      return "‚Ç°" + value.toLocaleString("es-CR");
    }

    function logEvent(eventType, data = {}) {
      const payload = {
        action: "logEvent",
        sessionId,
        eventType,
        timestamp: new Date().toISOString(),
        data: JSON.stringify(data || {})
      };

      // Log sencillo hacia Apps Script
      fetch(CONFIG.SHEETS_ENDPOINT, {
        method: "POST",
        mode: "no-cors", // para que no bloquee por CORS
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      }).catch((err) => {
        // Silenciar errores de log para no afectar al usuario
        console.warn("Log error (ignorado):", err);
      });
    }

    function enterStep(stepName) {
      const now = performance.now();
      const duration = now - stepStartTime;
      // Registrar duraci√≥n del step anterior
      if (currentStep) {
        logEvent("step_duration", {
          step: currentStep,
          durationMs: Math.round(duration)
        });
      }
      currentStep = stepName;
      stepStartTime = now;
      logEvent("step_enter", { step: stepName });

      // Mostrar/ocultar bloques
      const steps = ["producto", "detalle", "cliente", "confirmacion"];
      steps.forEach((s) => {
        const el = document.getElementById(`step-${s}`);
        if (el) {
          el.classList.toggle("active", s === stepName);
        }
      });
    }

    function getSelectedProduct() {
      return CONFIG.products.find((p) => p.id === state.productoId) || null;
    }

    function getSelectedPresentation() {
      const product = getSelectedProduct();
      if (!product) return null;
      return product.presentations.find((pr) => pr.id === state.presentacionId) || null;
    }

    function calculateTotal() {
      const presentacion = getSelectedPresentation();
      const gramos = Number(state.gramos) || 0;
      const cantidad = Number(state.cantidad) || 1;
      if (!presentacion || gramos <= 0 || cantidad <= 0) {
        state.totalColones = 0;
        return 0;
      }
      const kg = gramos / 1000;
      const total = Math.round(presentacion.pricePerKg * kg * cantidad);
      state.totalColones = total;
      return total;
    }

    function calculatePointsForAmount(amountColones) {
      if (!amountColones || amountColones <= 0) return 0;
      const blocks = Math.floor(amountColones / 1000);
      return blocks * CONFIG.POINTS_PER_1000;
    }

    /************************************************************
     * INICIALIZACI√ìN UI
     ************************************************************/
    function populateProducts() {
      const select = document.getElementById("producto");
      CONFIG.products.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
    }

    function populatePresentations() {
      const select = document.getElementById("presentacion");
      select.innerHTML = '<option value="">Selecciona la presentaci√≥n...</option>';
      const product = getSelectedProduct();
      if (!product) return;
      product.presentations.forEach((pr) => {
        const opt = document.createElement("option");
        opt.value = pr.id;
        opt.textContent = pr.label;
        select.appendChild(opt);
      });
    }

    function updateProductImage() {
      const wrapper = document.getElementById("product-image-wrapper");
      const img = document.getElementById("product-image");
      const product = getSelectedProduct();
      if (!product || !product.imageUrl) {
        wrapper.style.display = "none";
        img.src = "";
        return;
      }
      img.src = product.imageUrl;
      wrapper.style.display = "block";
    }

    function updatePriceSummary() {
      const total = calculateTotal();
      const totalEl = document.getElementById("total-colones");
      totalEl.textContent = formatMoneyCRC(total);

      // Recalcular puntos de esta compra
      const basePoints = calculatePointsForAmount(total);
      const welcomeBonus = state.welcomeBonus || 0;
      state.totalPointsThisOrder = basePoints + welcomeBonus;

      // Actualizar info de puntos en el bloque de cliente si ya lo vimos
      const pointsInfoEl = document.getElementById("points-info");
      if (state.telefono) {
        const totalAcumulado = (state.existingPoints || 0) + state.totalPointsThisOrder;
        let msg = "";
        if ((state.existingPoints || 0) === 0) {
          msg += "¬°Felicidades! Esta compra genera tus primeros puntos acumulables. ";
        }
        msg += `Esta compra genera <strong>${state.totalPointsThisOrder}</strong> puntos. `;
        msg += `Tus puntos acumulados ser√≠an aproximadamente <strong>${totalAcumulado}</strong>.`;
        pointsInfoEl.innerHTML = msg;
        pointsInfoEl.style.display = "block";
      }
    }

    function updateFinalSummary() {
      const product = getSelectedProduct();
      const presentacion = getSelectedPresentation();
      const resumenFinal = document.getElementById("resumen-final");
      const basePoints = calculatePointsForAmount(state.totalColones);
      const welcomeBonus = state.welcomeBonus || 0;
      const totalOrderPoints = state.totalPointsThisOrder || (basePoints + welcomeBonus);
      const totalAcumulado = (state.existingPoints || 0) + totalOrderPoints;

      let promoText = "";
      if (state.isNewCustomer && state.promoOptIn === "SI") {
        promoText = `<li>Recib√≠s <strong>10 puntos de bienvenida</strong> por aceptar promociones.</li>`;
      }

      const html = `
        <p><strong>Revis√° tu pedido:</strong></p>
        <ul>
          <li>Producto: <strong>${product ? product.name : "-"}</strong></li>
          <li>Presentaci√≥n: <strong>${presentacion ? presentacion.label : "-"}</strong></li>
          <li>Cantidad: <strong>${state.cantidad}</strong> x <strong>${state.gramos} g</strong></li>
          <li>Total estimado: <strong>${formatMoneyCRC(state.totalColones)}</strong></li>
        </ul>
        <p><strong>Tus datos:</strong></p>
        <ul>
          <li>Nombre: <strong>${state.nombre || "-"}</strong></li>
          <li>Celular: <strong>${state.telefono || "-"}</strong></li>
        </ul>
        <p><strong>Puntos:</strong></p>
        <ul>
          <li>Puntos generados por esta compra: <strong>${totalOrderPoints}</strong></li>
          ${promoText}
          <li>Puntos acumulados aproximados luego de este pedido: <strong>${totalAcumulado}</strong></li>
        </ul>
      `;
      resumenFinal.innerHTML = html;
    }

    /************************************************************
     * BACKEND (Apps Script) ‚Äì FETCH HELPERS
     ************************************************************/
    async function fetchCustomerInfo(phone) {
      const payload = {
        action: "getCustomerInfo",
        phone: phone
      };

      logEvent("fetch_customer_info", { phone });

      try {
        const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // si Apps Script responde JSON
        const data = await res.json();
        return data;
      } catch (err) {
        console.error("Error consultando info del cliente:", err);
        return { success: false };
      }
    }

    async function sendOrder() {
      const statusEl = document.getElementById("status");
      statusEl.textContent = "Enviando pedido...";
      statusEl.classList.remove("error");

      const payload = {
        action: "saveOrder",
        sessionId,
        productoId: state.productoId,
        presentacionId: state.presentacionId,
        gramos: state.gramos,
        cantidad: state.cantidad,
        totalColones: state.totalColones,
        nombre: state.nombre,
        telefono: state.telefono,
        comentarios: state.comentarios,
        isNewCustomer: state.isNewCustomer,
        promoOptIn: state.promoOptIn,
        pointsThisOrder: state.totalPointsThisOrder
      };

      logEvent("send_order_attempt", payload);

      try {
        const res = await fetch(CONFIG.SHEETS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        let data = {};
        try {
          data = await res.json();
        } catch (e) {
          // Si no devuelve JSON igual asumimos √©xito si status ok
          data = { success: res.ok };
        }

        if (!data.success) {
          throw new Error(data.message || "Error desconocido en el servidor");
        }

        logEvent("send_order_success", { telefono: state.telefono, totalColones: state.totalColones });

        statusEl.textContent = "Pedido enviado con √©xito. Te contactaremos por WhatsApp para confirmar. üôå";

        // Aqu√≠ tambi√©n pod√©s generar el link de WhatsApp:
        const mensaje = encodeURIComponent(
          `Hola, soy ${state.nombre} (${state.telefono}). Quiero pedir:\n` +
          `- ${getSelectedProduct()?.name || ""}\n` +
          `- ${getSelectedPresentation()?.label || ""}\n` +
          `- ${state.cantidad} x ${state.gramos} g\n` +
          `Total estimado: ${formatMoneyCRC(state.totalColones)}\n\n` +
          `Comentarios: ${state.comentarios || "Ninguno"}`
        );
        const waUrl = `https://wa.me/50660228322?text=${mensaje}`; // <-- Cambia al n√∫mero de Monte Alto
        window.open(waUrl, "_blank");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Hubo un problema al enviar el pedido. Intenta de nuevo.";
        statusEl.classList.add("error");
        logEvent("send_order_error", { error: String(err) });
      }
    }

    /************************************************************
     * EVENTOS UI
     ************************************************************/
    function setupEvents() {
      const productoSelect = document.getElementById("producto");
      const presentacionSelect = document.getElementById("presentacion");
      const gramosInput = document.getElementById("gramos");
      const cantidadInput = document.getElementById("cantidad");
      const nombreInput = document.getElementById("nombre");
      const telefonoInput = document.getElementById("telefono");
      const comentariosInput = document.getElementById("comentarios");
      const btnEnviar = document.getElementById("btn-enviar");
      const btnAtras = document.getElementById("btn-atras");
      const promoWrapper = document.getElementById("promo-optin-wrapper");
      const pointsInfoEl = document.getElementById("points-info");

      productoSelect.addEventListener("change", () => {
        state.productoId = productoSelect.value || "";
        logEvent("producto_change", { productoId: state.productoId });

        if (!state.productoId) {
          updateProductImage();
          return;
        }

        updateProductImage();
        populatePresentations();

        // Al escoger producto, revelamos el siguiente paso
        enterStep("detalle");
      });

      presentacionSelect.addEventListener("change", () => {
        state.presentacionId = presentacionSelect.value || "";
        const presentacion = getSelectedPresentation();
        logEvent("presentacion_change", { presentacionId: state.presentacionId });

        if (presentacion && (!gramosInput.value || Number(gramosInput.value) === 0)) {
          gramosInput.value = presentacion.gramsDefault;
          state.gramos = presentacion.gramsDefault;
        }

        updatePriceSummary();
      });

      gramosInput.addEventListener("input", () => {
        state.gramos = Number(gramosInput.value) || 0;
        logEvent("gramos_input", { gramos: state.gramos });
        updatePriceSummary();
      });

      cantidadInput.addEventListener("input", () => {
        state.cantidad = Number(cantidadInput.value) || 1;
        logEvent("cantidad_input", { cantidad: state.cantidad });
        updatePriceSummary();
      });

      nombreInput.addEventListener("input", () => {
        state.nombre = nombreInput.value.trim();
      });

      telefonoInput.addEventListener("change", async () => {
        state.telefono = telefonoInput.value.trim();
        if (!state.telefono) return;

        const data = await fetchCustomerInfo(state.telefono);
        if (!data || !data.success) {
          // No se pudo consultar, asumimos 0 puntos y que es nuevo
          state.isNewCustomer = true;
          state.existingPoints = 0;
        } else {
          state.isNewCustomer = !!data.isNewCustomer;
          state.existingPoints = Number(data.points || 0);
        }

        // Si no tiene puntos (o es nuevo), mensaje especial
        let msg = "";
        if ((state.existingPoints || 0) === 0) {
          msg += "¬°Felicidades! Esta compra generar√° tus primeros puntos acumulables. ";
        } else {
          msg += `Actualmente llev√°s aproximadamente <strong>${state.existingPoints}</strong> puntos acumulados. `;
        }

        // Recalcular puntos con posible bonus
        const basePoints = calculatePointsForAmount(state.totalColones);

        state.welcomeBonus = 0;
        state.totalPointsThisOrder = basePoints;

        pointsInfoEl.innerHTML = msg;
        pointsInfoEl.style.display = "block";

        // Si es nuevo cliente, mostrar el opt-in de promos
        if (state.isNewCustomer) {
          promoWrapper.style.display = "block";
        } else {
          promoWrapper.style.display = "none";
          state.promoOptIn = null;
        }

        updatePriceSummary();
      });

      // Radios de promo opt-in
      document.querySelectorAll('input[name="promo_optin"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          state.promoOptIn = radio.value;
          // Si acepta promos y es nuevo cliente -> 10 puntos de bienvenida
          if (state.isNewCustomer && state.promoOptIn === "SI") {
            state.welcomeBonus = 10;
          } else {
            state.welcomeBonus = 0;
          }
          logEvent("promo_optin_change", {
            promoOptIn: state.promoOptIn,
            welcomeBonus: state.welcomeBonus
          });
          updatePriceSummary();
        });
      });

      comentariosInput.addEventListener("input", () => {
        state.comentarios = comentariosInput.value.trim();
      });

      btnEnviar.addEventListener("click", async () => {
        // Validaciones b√°sicas
        if (!state.productoId || !state.presentacionId || !state.gramos || !state.cantidad) {
          alert("Revis√° que el producto, presentaci√≥n, gramos y cantidad est√©n completos.");
          return;
        }
        if (!state.nombre || !state.telefono) {
          alert("Por favor ingres√° tu nombre y n√∫mero de celular.");
          return;
        }
        if (state.isNewCustomer && state.promoOptIn === null) {
          alert("Confirm√° si quer√©s o no recibir promociones por WhatsApp.");
          return;
        }

        updateFinalSummary();
        logEvent("send_order_click", {
          productoId: state.productoId,
          presentacionId: state.presentacionId,
          gramos: state.gramos,
          cantidad: state.cantidad,
          totalColones: state.totalColones,
          nombre: state.nombre,
          telefono: state.telefono,
          promoOptIn: state.promoOptIn
        });

        await sendOrder();
      });

      btnAtras.addEventListener("click", () => {
        // Volver al paso de cliente
        enterStep("cliente");
      });

      // Cuando termina de llenar detalle del pedido, pasamos a cliente
      // Pod√©s decidir exactamente cu√°ndo; aqu√≠ lo hacemos si total > 0 y cambia algo
      ["change", "blur"].forEach((evName) => {
        gramosInput.addEventListener(evName, () => {
          if (state.totalColones > 0 && currentStep === "detalle") {
            enterStep("cliente");
          }
        });
        cantidadInput.addEventListener(evName, () => {
          if (state.totalColones > 0 && currentStep === "detalle") {
            enterStep("cliente");
          }
        });
      });

      // Cuando se cambia algo en datos de cliente y ya est√° listo todo, podemos mostrar confirmaci√≥n
      comentariosInput.addEventListener("blur", () => {
        if (state.nombre && state.telefono && state.totalColones > 0) {
          updateFinalSummary();
          enterStep("confirmacion");
        }
      });
      nombreInput.addEventListener("blur", () => {
        if (state.nombre && state.telefono && state.totalColones > 0) {
          updateFinalSummary();
          enterStep("confirmacion");
        }
      });
      telefonoInput.addEventListener("blur", () => {
        if (state.nombre && state.telefono && state.totalColones > 0) {
          updateFinalSummary();
          enterStep("confirmacion");
        }
      });
    }

    /************************************************************
     * START
     ************************************************************/
    window.addEventListener("load", () => {
      populateProducts();
      setupEvents();
      logEvent("page_view", { url: location.href });
      enterStep("producto");
      updatePriceSummary();
    });
  </script>
</body>
</html>
